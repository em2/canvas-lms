define(["i18nObj","jquery","instructure-jquery.ui.draggable-patch","jquery.instructure_jquery_patches","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","vendor/jquery.scrollTo","vendor/jquery.ba-tinypubsub","vendor/scribd.view"],function(a,b){function d(){this._textareas={},this._editors={},this._editor_boxes={}}function f(a,c){var d=b("#"+a+"_ifr");if(d.length){var e=b(window).height()-(d.offset().top+c.height()+1);d.height(e)}b("#"+a+"_tbl").css("height","")}function g(a,d,g,h,i){i=b.extend({},i),i.fullHeight&&b(window).resize(function(){f(a,i.elementToLeaveInViewport)}).triggerHandler("resize");var j=b("#"+a);j.data("enable_bookmarking",c);var k=j.width();k==0&&(k=j.closest(":visible").width());var l=",instructure_embed,instructure_equation";for(var m in INST.editorButtons)INST.editorButtons.length<=INST.maxVisibleEditorButtons||m<INST.maxVisibleEditorButtons-1?l=l+",instructure_external_button_"+INST.editorButtons[m].id:l.match(/instructure_external_button_clump/)||(l+=",instructure_external_button_clump");INST&&INST.allowMediaComments&&(l+=",instructure_record");var n=INST&&INST.equellaEnabled?",instructure_equella":"";l+=n;var o="bold,italic,underline,forecolor,backcolor,removeformat,sepleft,separator,justifyleft,justifycenter,justifyright,sepleft,separator,bullist,outdent,indent,numlist,sepleft,separator,table,instructure_links,unlink"+l+",|,fontsizeselect,formatselect",p="",q="";k<359&&k>0?(o="bold,italic,underline,forecolor,backcolor,removeformat,sepleft,separator,justifyleft,justifycenter,justifyright",p="outdent,indent,bullist,numlist,sepleft,separator,table,instructure_links,unlink"+l,q="fontsizeselect,formatselect"):k<629&&(o="bold,italic,underline,forecolor,backcolor,removeformat,sepleft,separator,justifyleft,justifycenter,justifyright,sepleft,separator,outdent,indent,bullist,numlist",p="table,instructure_links,unlink"+l+",|,fontsizeselect,formatselect");var r="/javascripts/tinymce/jscripts/tiny_mce/themes/advanced/skins/default/ui.css,/stylesheets/compiled/tiny_like_ck_with_external_tools.css";tinyMCE.init({mode:"exact",elements:a,theme:"advanced",plugins:"autolink,instructure_external_tools,instructure_contextmenu,instructure_links,instructure_embed,instructure_equation,instructure_record,instructure_equella,media,paste,table,inlinepopups",dialog_type:"modal",language_load:!1,relative_urls:!1,remove_script_host:!0,theme_advanced_buttons1:o,theme_advanced_toolbar_location:"top",theme_advanced_buttons2:p,theme_advanced_buttons3:q,theme_advanced_resize_horizontal:!1,theme_advanced_resizing:!0,theme_advanced_fonts:'Andale Mono=andale mono,times;Arial=arial,helvetica,sans-serif;Arial Black=arial black,avant garde;Book Antiqua=book antiqua,palatino;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier;Georgia=georgia,palatino;Helvetica=helvetica;Impact=impact,chicago;Myriad="Myriad Pro",Myriad,Arial,sans-serif;Symbol=symbol;Tahoma=tahoma,arial,helvetica,sans-serif;Terminal=terminal,monaco;Times New Roman=times new roman,times;Trebuchet MS=trebuchet ms,geneva;Verdana=verdana,geneva;Webdings=webdings;Wingdings=wingdings,zapf dingbats;',theme_advanced_blockformats:"p,h2,h3,h4,pre",theme_advanced_more_colors:!1,extended_valid_elements:"iframe[src|width|height|name|align|style|class]",content_css:"/stylesheets/compiled/instructure_style.css,/stylesheets/compiled/tinymce.editor_box.css",editor_css:r,handle_event_callback:function(c){if(c.type.indexOf("keydown")===0||c.type.indexOf("keypress")===0)if(c.keyCode===9){if(c.shiftKey){c.preventDefault();var d=b("#"+a),e=d.closest("form,#main").find(":tabbable,#"+a);m=e.index(d),d.filter(":visible").length>0?b(e.eq(m-1)).focus():b(e.eq(m+1)).focus()}}else b("#"+a).triggerHandler(c.type,b.event.fix(c))},onchange_callback:function(c){b("#"+a).trigger("change")},setup:function(d){var e=b("#"+d.editorId),f=function(){b(document).triggerHandler("editor_box_focus",e),b.publish("editorBox/focus",e)};d.onClick.add(f),d.onKeyPress.add(f),d.onActivate.add(f),d.onEvent.add(function(){c&&d.selection&&j.data("last_bookmark",d.selection.getBookmark(1))}),d.onInit.add(function(){b(window).triggerHandler("resize"),b(d.contentDocument).bind("DOMNodeInserted",function(a){var c=a.target,d;c.nodeType===1&&c.nodeName==="IMG"&&(d=b(c).data("url"))&&b(c).attr("src",tinyMCE.activeEditor.documentBaseURI.toAbsolute(d))}),"onfocusout"in d.contentWindow||b(d.contentWindow).blur(function(a){!d.removed&&d.undoManager.typing&&(d.undoManager.typing=!1,d.undoManager.add())}),b("#"+d.editorId+"_tbl").find("td.mceToolbar span.mceSeparator").parent().each(function(){b(this).after("<td class='mceSeparatorLeft'><span/></td>").after("<td class='mceSeparatorMiddle'><span/></td>").after("<td class='mceSeparatorRight'><span/></td>").remove()});if(!i.unresizable)var c=b("#"+a+"_ifr"),e=c.closest(".mceEditor"),f,g,h,j=i.minHeight||200,k=b('<div class="editor_box_resizer" unselectable="on"><div class="ui-icon ui-icon-grip-diagonal-se" unselectable="on"></div></div>').appendTo(c.parent()).draggable({axis:"y",instructureHackToNotAutoSizeTop:!0,containment:[0,c.offset().top+j,9999999,9999999],start:function(){h=e.css("overflow"),e.css("overflow","hidden"),f=c.offset().top,k.draggable("option","containment",[0,f+j,9999999,9999999]),g=b('<div style="position: absolute; width: 100%; height: 100%; top: 0; left: 0;"></div>').appendTo(k.parent())},drag:function(a,b){k.removeAttr("style"),c.height(b.offset.top-f)},stop:function(a,b){g.remove(),e.css("overflow",h),k.removeAttr("style"),c.height(b.offset.top-f)}})})}}),this._textarea=j,this._editor=null,this._id=a,this._searchURL=d,this._submitURL=g,this._contentURL=h,e._addEditorBox(a,this),j.bind("blur change",function(){e._getEditor(a)&&e._getEditor(a).isHidden()&&b(this).editorBox("set_code",e._getTextArea(a).val())})}var c=b("body").hasClass("ie");b(document).ready(function(){c=b("body").hasClass("ie")}),b.extend(d.prototype,{_addEditorBox:function(a,c){b.publish("editorBox/add",a,c),this._editor_boxes[a]=c,this._editors[a]=tinyMCE.get(a),this._textareas[a]=b("textarea#"+a)},_removeEditorBox:function(a){delete this._editor_boxes[a],delete this._editors[a],delete this._textareas[a],b.publish("editorBox/remove",a),b.isEmptyObject(this._editors)&&b.publish("editorBox/removeAll")},_getTextArea:function(a){return this._textareas[a]||(this._textareas[a]=b("textarea#"+a)),this._textareas[a]},_getEditor:function(a){return this._editors[a]||(this._editors[a]=tinyMCE.get(a)),this._editors[a]},_getEditorBox:function(a){return this._editor_boxes[a]}});var e=new d,h={getSelection:function(){var a=this.jquery?this[0]:this;return("selectionStart"in a&&function(){var b=a.selectionEnd-a.selectionStart;return{start:a.selectionStart,end:a.selectionEnd,length:b,text:a.value.substr(a.selectionStart,b)}}||document.selection&&function(){a.focus();var b=document.selection.createRange();if(b==null)return{start:0,end:a.value.length,length:0};var c=a.createTextRange(),d=c.duplicate();return c.moveToBookmark(b.getBookmark()),d.setEndPoint("EndToStart",c),{start:d.text.length,end:d.text.length+b.text.length,length:b.text.length,text:b.text}}||function(){return{start:0,end:a.value.length,length:0}})()},replaceSelection:function(){var a=this.jquery?this[0]:this,b=arguments[0]||"";return("selectionStart"in a&&function(){return a.value=a.value.substr(0,a.selectionStart)+b+a.value.substr(a.selectionEnd,a.value.length),this}||document.selection&&function(){return a.focus(),document.selection.createRange().text=b,this}||function(){return a.value+=b,this})()}};jQuery.each(h,function(a){jQuery.fn[a]=this});var i=1;b.fn.editorBox=function(a,c){var d=arguments;if(this.length>1)return this.each(function(){var a=b(this);a.editorBox.apply(a,d)});var f=this.attr("id");if(typeof a=="string"&&a!="create"){if(a=="get_code")return this._getContentCode(c);if(a=="set_code")this._setContentCode(c);else if(a=="insert_code")this._insertHTML(c);else{if(a=="selection_offset")return this._getSelectionOffset();if(a=="selection_link")return this._getSelectionLink();if(a=="create_link")this._linkSelection(c);else{if(a=="focus")return this._editorFocus(c);if(a=="toggle")this._toggleView();else{if(a=="execute"){var h=[];for(var j=1;j<arguments.length;j++)h.push(arguments[j]);return b.fn._execCommand.apply(this,h)}a=="destroy"&&this._removeEditor(c)}}}return this}this.data("rich_text",!0),f||(f="editor_box_unique_id_"+i++,this.attr("id",f));if(e._getEditor(f))return this._setContentCode(this.val()),this;var k="";a&&a.search_url&&(k=a.search_url);var l=new g(f,k,"","",a);return this},b.fn._execCommand=function(){var a=b(this).attr("id"),c=e._getEditor(a);return c&&c.execCommand&&c.execCommand.apply(c,arguments),this},b.fn._justGetCode=function(){var a=this.attr("id")||"",b="";try{e._getEditor(a).isHidden()?b=e._getTextArea(a).val():b=e._getEditor(a).getContent()}catch(c){tinyMCE&&tinyMCE.getInstanceById(a)?b=tinyMCE.getInstanceById(a).getContent():b=this.val()||""}return b},b.fn._getContentCode=function(a){if(a==1){var b=this._justGetCode();this._setContentCode(b)}return this._justGetCode()},b.fn._getSearchURL=function(){return e._getEditorBox(this.attr("id"))._searchURL},b.fn._getSubmitURL=function(){return e._getEditorBox(this.attr("id"))._submitURL},b.fn._getContentURL=function(){return e._getEditorBox(this.attr("id"))._contentURL},b.fn._getSelectionOffset=function(){var a=this.attr("id"),c=e._getEditor(a).getContainer(),d=b(c).find("iframe").offset(),f=e._getEditor(a).selection.getNode(),g=b(f).offset(),h=b(c).scrollTop(),i={left:d.left+g.left+10,top:d.top+g.top+10-h};return i},b.fn._getSelectionNode=function(){var a=this.attr("id"),b=e._getEditor(a).getContainer(),c=e._getEditor(a).selection.getNode();return c},b.fn._getSelectionLink=function(){var a=this.attr("id"),c=tinyMCE.get(a).selection.getNode();while(c.nodeName!="A"&&c.nodeName!="BODY"&&c.parentNode)c=c.parentNode;if(c.nodeName=="A"){var d=b(c).attr("href"),e=b(c).attr("title");if(!e||e=="")e=d;var f={url:d,title:e};return f}return null},b.fn._toggleView=function(){var a=this.attr("id");this._setContentCode(this._getContentCode()),tinyMCE.execCommand("mceToggleEditor",!1,a)},b.fn._removeEditor=function(){var a=this.attr("id");this.data("rich_text",!1),tinyMCE&&tinyMCE.execCommand&&(tinyMCE.execCommand("mceRemoveControl",!1,a),e._removeEditorBox(a))},b.fn._setContentCode=function(a){var c=this.attr("id");e._getTextArea(c).val(a),tinyMCE.get(c)&&b.isFunction(tinyMCE.get(c).execCommand)&&tinyMCE.get(c).execCommand("mceSetContent",!1,a)},b.fn._insertHTML=function(a){var b=this.attr("id");e._getEditor(b).isHidden()?this.replaceSelection(a):tinyMCE.get(b).execCommand("mceInsertContent",!1,a)},b.fn._editorFocus=function(a){var c=this,d=c.attr("id"),f=e._getEditor(d);return a&&(!f||!f.dom.doc.hasFocus())&&setTimeout(function(){c.editorBox("focus",!0)},50),f?(e._getEditor(d).isHidden()?e._getTextArea(d).focus().select():(tinyMCE.execCommand("mceFocus",!1,d),b.publish("editorBox/focus",c)),!0):!1},b.fn._linkSelection=function(a){typeof a=="string"&&(a={url:a});var d=a.title,f=a.url||"";f.match(/@/)&&!f.match(/\//)&&!f.match(/^mailto:/)?f="mailto:"+f:!f.match(/^\w+:\/\//)&&!f.match(/^mailto:/)&&!f.match(/^\//)&&(f="http://"+f);var g=a.classes||"",h=a.text||a.title||"Link",i=a.target||null,j=b(this).attr("id");f.indexOf("@")!=-1?(a.file=!1,a.image=!1,f.indexOf("mailto:")!=0&&(f="mailto:"+f)):f.indexOf("/")==-1&&(d=f,f=f.replace(/\s/g,""),f=location.href+f),a.file&&(g+="instructure_file_link "),a.scribdable&&(g+="instructure_scribd_file ");var k="";a.kaltura_entry_id&&a.kaltura_media_type&&(k="media_comment_"+a.kaltura_entry_id,a.kaltura_media_type=="video"?g+="instructure_video_link ":g+="instructure_audio_link "),a.image&&(g+="instructure_image_thumbnail "),g=b.uniq(g.split(/\s+/)).join(" ");var l="";c&&this.data("last_bookmark")&&tinyMCE.get(j).selection.moveToBookmark(this.data("last_bookmark"));var m=tinyMCE.get(j).selection,n=m.getNode();while(n.nodeName!="A"&&n.nodeName!="BODY"&&n.parentNode)n=n.parentNode;n.nodeName!="A"&&(n=null);var o=m.getContent();if(e._getEditor(j).isHidden()){l=h;var p=b("<div><a/></div>");p.find("a")[k?"attr":"removeAttr"]("id",k).attr({title:d,href:f,target:i})[g?"attr":"removeAttr"]("class",g).text(l);var q=p.html();b(this).replaceSelection(q)}else if(!o||o=="")if(n)b(n).attr({href:f,_mce_href:f,title:d||"",id:k,"class":g,target:i});else{l=h;var p=b("<div/>");p.append(b("<a/>",{id:k,target:i,title:d,href:f,"class":g}).text(l)),tinyMCE.get(j).execCommand("mceInsertContent",!1,p.html())}else tinyMCE.get(j).execCommand("mceInsertLink",!1,{target:i||"",title:d||"",href:f,"class":g,id:k});var r=tinyMCE.get(j),s=r.selection.getNode();s.nodeName!="A"&&(s=b(s).children("a:last")[0]);if(s){var t={top:s.offsetTop,left:s.offsetLeft},u=s;while((u=u.offsetParent)&&u.tagName!="BODY")t.top=t.top+u.offsetTop||0,t.left=t.left+u.offsetLeft||0;var v=r.getContainer(),w=b(v).find("iframe").offset(),x=b(r.dom.doc).find("html").scrollTop()||b(r.dom.doc).find("body").scrollTop(),y={left:w.left+t.left,top:w.top+t.top-x};b(s).indicate({offset:y,singleFlash:!0,scroll:!0,container:b(v).find("iframe")})}}})