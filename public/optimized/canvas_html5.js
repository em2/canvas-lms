function prepareCanvas(a,b,c,d){function e(){++M>=L&&h()}function f(a,d,e){c==1&&(v.push(a),w.push(d),y.push(D),x.push(C),z.push(E),A.push(e),$("#explain_canvas_"+b+"_click_x_data").val(v.toString()),$("#explain_canvas_"+b+"_click_y_data").val(w.toString()),$("#explain_canvas_"+b+"_click_color_data").val(x.toString()),$("#explain_canvas_"+b+"_click_tool_data").val(y.toString()),$("#explain_canvas_"+b+"_click_size_data").val(z.toString()),$("#explain_canvas_"+b+"_click_drag_data").val(A.toString()),$("#explain_canvas_"+b+"_click_x_data").change())}function g(){j.clearRect(0,0,k,l)}function h(){if(M<L)return;g(),D=="marker"&&c==1?j.drawImage(s,0,0,k,l):D=="eraser"&&c==1?j.drawImage(t,0,0,k,l):c?alert("Error: Current Tool is undefined"):j.drawImage(u,0,0,k-104,l);var a=313,b=75;c==1&&(j.beginPath(),j.moveTo(a,b),j.lineTo(a+10,b+6),j.lineTo(a,b+11),j.lineTo(a,b),j.closePath(),j.fillStyle=q,j.fill()),j.save(),j.beginPath(),j.rect(F,G,H,I),j.clip();var d,e=0;for(;e<v.length;e++)z[e]=="small"?d=2:z[e]=="normal"?d=3:z[e]=="large"?d=10:z[e]=="huge"?d=20:(alert("Error: Radius is zero for click "+e),d=0),j.beginPath(),A[e]&&e?j.moveTo(v[e-1]-15,w[e-1]-70):j.moveTo(v[e]-15,w[e]-70),j.lineTo(v[e]-15,w[e]-70),j.closePath(),y[e]=="eraser"?j.strokeStyle="white":j.strokeStyle=x[e],j.lineJoin="round",j.lineWidth=d,j.stroke();j.restore(),j.globalAlpha=1}if(d==1)return;var i,j,k=386,l=220,m=25,n=8,o="#cb3594",p="#659b41",q="#0033ff",r="#000000",s=new Image,t=new Image,u=new Image,v=new Array,w=new Array,x=new Array,y=new Array,z=new Array,A=new Array,B=!1,C=q,D="marker",E="normal",F=7,G=11,H=267,I=200,J=95,K=38,L=3,M=0;if($("#explain_canvas_"+b+"_click_x_data").val().length>0){v=$("#explain_canvas_"+b+"_click_x_data").val(),v=v.split(","),w=$("#explain_canvas_"+b+"_click_y_data").val(),w=w.split(","),x=$("#explain_canvas_"+b+"_click_color_data").val(),x=x.split(","),y=$("#explain_canvas_"+b+"_click_tool_data").val(),y=y.split(","),z=$("#explain_canvas_"+b+"_click_size_data").val(),z=z.split(","),A=$("#explain_canvas_"+b+"_click_drag_data").val(),A=A.split(",");for(var N=0;N<v.length;N++)v[N]=parseInt(v[N]),w[N]=parseInt(w[N]);for(var N=0;N<A.length;N++)A[N]=="true"?A[N]=!0:A[N]=!1}var O=document.getElementById(a),i=document.createElement("canvas");i.setAttribute("width",k),i.setAttribute("height",l),i.setAttribute("id","canvas_"+a),i.setAttribute("name","canvas_"+a),O.appendChild(i),typeof G_vmlCanvasManager!="undefined"&&(i=G_vmlCanvasManager.initElement(i));var j=i.getContext("2d");s.onload=function(){e()},s.src="../../../../images/canvas_drawing/marker-background.png",t.onload=function(){e()},t.src="../../../../images/canvas_drawing/eraser-background.png",u.onload=function(){e()},u.src="../../../../images/canvas_drawing/plain-background.png",$("#canvas_"+a).mousedown(function(a){if(c==1){var b=a.pageX-this.offsetLeft,d=a.pageY-this.parentNode.parentNode.parentNode.parentNode.parentNode.offsetTop-this.offsetTop+60;b>F+H+16?d>J&&(d<J+K*2?(D="marker",E="normal"):d<J+K*3&&(D="eraser",E="huge")):d<=G||d>=G+I,B=!0,f(b,d,!1),h()}}),$("#canvas_"+a).mousemove(function(a){B==1&&c==1&&(f(a.pageX-this.offsetLeft,a.pageY-this.parentNode.parentNode.parentNode.parentNode.parentNode.offsetTop-this.offsetTop+60,!0),h())}),$("#canvas_"+a).mouseup(function(a){c==1&&(B=!1,h())}),$("#canvas_"+a).mouseleave(function(a){c==1&&(B=!1)})}