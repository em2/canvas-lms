function prepareCanvas(a,b,c,d){function N(){++L>=K&&Y()}function P(){c&&(h=!0,R())}function Q(){c&&(h=!1,S())}function R(a){if(!a)var a=event;c&&(f=a.pageX-e.offsetLeft,g=a.pageY-e.parentNode.parentNode.parentNode.parentNode.parentNode.offsetTop-e.offsetTop+60,V(),Y())}function S(a){if(!a)var a=event;c&&(a.preventDefault(),f=a.targetTouches[0].pageX-e.offsetLeft,g=a.targetTouches[0].pageY-e.parentNode.parentNode.parentNode.parentNode.parentNode.offsetTop-e.offsetTop+60,V(),Y(),h||(h=!0))}function T(){c&&(h=!1,A=!1)}function U(){c&&(h=!1,A=!1)}function V(){f>E+G+16&&g>I&&!h&&(g<I+J*2?(C="marker",D="normal"):g<I+J*3&&(C="eraser",D="huge")),A=!0,W()}function W(){c&&A&&(u.push(f),v.push(g),x.push(C),w.push(B),y.push(D),z.push(h),$("#explain_canvas_"+b+"_click_x_data").val(u.toString()),$("#explain_canvas_"+b+"_click_y_data").val(v.toString()),$("#explain_canvas_"+b+"_click_color_data").val(w.toString()),$("#explain_canvas_"+b+"_click_tool_data").val(x.toString()),$("#explain_canvas_"+b+"_click_size_data").val(y.toString()),$("#explain_canvas_"+b+"_click_drag_data").val(z.toString()),$("#explain_canvas_"+b+"_click_x_data").change())}function X(){i.clearRect(0,0,j,k)}function Y(){if(L<K)return;X(),C=="marker"&&c==1?i.drawImage(r,0,0,j,k):C=="eraser"&&c==1?i.drawImage(s,0,0,j,k):c?alert("Error: Current Tool is undefined"):i.drawImage(t,0,0,j-104,k);var a=313,b=75;c==1&&(i.beginPath(),i.moveTo(a,b),i.lineTo(a+10,b+6),i.lineTo(a,b+11),i.lineTo(a,b),i.closePath(),i.fillStyle=p,i.fill()),i.save(),i.beginPath(),i.rect(E,F,G,H),i.clip();var d,e=0;for(;e<u.length;e++)y[e]=="small"?d=2:y[e]=="normal"?d=3:y[e]=="large"?d=10:y[e]=="huge"?d=20:(alert("Error: Radius is zero for click "+e),d=0),i.beginPath(),z[e]&&e?i.moveTo(u[e-1]-15,v[e-1]-70):i.moveTo(u[e]-15,v[e]-70),i.lineTo(u[e]-15,v[e]-70),i.closePath(),x[e]=="eraser"?i.strokeStyle="white":i.strokeStyle=w[e],i.lineJoin="round",i.lineWidth=d,i.stroke();i.restore(),i.globalAlpha=1}if(d==1)return;var e,f,g,h=!1,i,j=386,k=220,l=25,m=8,n="#cb3594",o="#659b41",p="#0033ff",q="#000000",r=new Image,s=new Image,t=new Image,u=new Array,v=new Array,w=new Array,x=new Array,y=new Array,z=new Array,A=!1,B=p,C="marker",D="normal",E=7,F=11,G=267,H=200,I=95,J=38,K=3,L=0;if($("#explain_canvas_"+b+"_click_x_data").val().length>0){u=$("#explain_canvas_"+b+"_click_x_data").val(),u=u.split(","),v=$("#explain_canvas_"+b+"_click_y_data").val(),v=v.split(","),w=$("#explain_canvas_"+b+"_click_color_data").val(),w=w.split(","),x=$("#explain_canvas_"+b+"_click_tool_data").val(),x=x.split(","),y=$("#explain_canvas_"+b+"_click_size_data").val(),y=y.split(","),z=$("#explain_canvas_"+b+"_click_drag_data").val(),z=z.split(",");for(var M=0;M<u.length;M++)u[M]=parseInt(u[M]),v[M]=parseInt(v[M]);for(var M=0;M<z.length;M++)z[M]=="true"?z[M]=!0:z[M]=!1}var O=document.getElementById(a),e=document.createElement("canvas");e.setAttribute("width",j),e.setAttribute("height",k),e.setAttribute("id","canvas_"+a),e.setAttribute("name","canvas_"+a),O.appendChild(e),typeof G_vmlCanvasManager!="undefined"&&(e=G_vmlCanvasManager.initElement(e));var i=e.getContext("2d");r.onload=function(){N()},r.src="../../../../images/canvas_drawing/marker-background.png",s.onload=function(){N()},s.src="../../../../images/canvas_drawing/eraser-background.png",t.onload=function(){N()},t.src="../../../../images/canvas_drawing/plain-background.png",$("#canvas_"+a).bind("mousedown",function(a){P()}),$("#canvas_"+a).bind("mousemove",function(a){R(a.originalEvent)}),$(document.body).bind("mouseup",function(a){T()}),$("#canvas_"+a).bind("touchstart",function(a){Q()}),$("#canvas_"+a).bind("touchmove",function(a){S(a.originalEvent)}),$("#canvas_"+a).bind("touchend",function(a){U()}),$(document.body).bind("touchcancel",function(a){U()})}