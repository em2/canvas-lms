define(["vendor/slickgrid-googlecode/slick.globaleditorlock","jquery","jqueryui/sortable","jqueryui/resizable","vendor/jquery.getScrollbarWidth"],function(a,b){return function c(c,d,e,f){function N(){f=b.extend({},g,f),c.empty().attr("tabIndex",0).attr("hideFocus",!0).css("overflow","hidden").css("outline",0).css("position","relative").addClass(k),m=b("<div class='grid-header' style='overflow:hidden;position:relative;' />").appendTo(c),n=b("<div style='width:10000px' />").appendTo(m),o=b("<div tabIndex='0' hideFocus style='width:100%;overflow:scroll;outline:0;position:relative;outline:0px;'>").appendTo(c),p=b("<div class='grid-canvas' tabIndex='0' hideFocus />").appendTo(o),o.height(c.innerHeight()-m.outerHeight());for(var a=0;a<e.length;a++){var d=e[a];G[d.id]=a,d.width||(d.width=f.defaultColumnWidth),d.formatter||(d.formatter=W);var h=b("<div class='h c"+a+"' cell="+a+" id='"+d.id+"' />").html(d.name).width(d.width).appendTo(n);d.rerenderOnResize&&h.append(" <img src='images/help.png' align='absmiddle' title='This column has an adaptive formatter.  Resize to a smaller size to see alternative data representation.'>")}n.find(".h").each(function(){var a=parseInt(b(this).attr("cell")),c=e[a];if(c.resizable===!1)return;b(this).resizable({handles:"e",minWidth:c.minWidth?c.minWidth:null,maxWidth:c.maxWidth?c.maxWidth:null,stop:function(a,c){var d=b(this).attr("id"),f=G[d];e[f].width=b(this).width(),b("body").append("<style class='slick-style'> ."+k+" .grid-canvas .c"+f+"{width: "+e[f].width+"px;} </style>"),be(),e[f].rerenderOnResize&&_(),bh()}})}),f.enableColumnReorder&&n.sortable({axis:"x",cancel:".ui-resizable-handle",update:function(a,b){console.time("column reorder");var c=n.sortable("toArray"),d={};for(var f=0;f<e.length;f++)d[e[f].id]=e[f];for(var f=0;f<c.length;f++)G[c[f]]=f,e[f]=d[c[f]];_(),P(),O(),bh(),l.onColumnsReordered&&l.onColumnsReordered(),a.stopPropagation(),console.timeEnd("column reorder")}}),n.bind("click",function(a){if(!b(a.target).hasClass(".h"))return;var c=b(a.target).attr("id");l.onColumnHeaderClick&&l.onColumnHeaderClick(e[G[c]])}),O(),be(),bh(),f.manualScrolling||o.bind("scroll",bi),p.bind("keydown",bj),p.bind("click",bk),p.bind("dblclick",bl),b.browser.msie&&(o[0].onselectstart=function(){if(event.srcElement.tagName!="INPUT"&&event.srcElement.tagName!="TEXTAREA")return!1})}function O(){for(var a=0;a<e.length;a++)b("body").append("<style class='slick-style'> ."+k+" .grid-canvas .c"+a+" { width:"+e[a].width+"px } </style>")}function P(){b("body").find("style.slick_style").remove()}function Q(){v&&bx(),n.sortable("destroy"),n.find(".h").resizable("destroy"),P(),c.empty().removeClass(k)}function R(a,b,c){n.find(".h[id="+a+"]").removeClass(c).addClass(b)}function S(a){return G[a]}function T(){return E.concat()}function U(c){if(a.isEditing()&&!a.hasLock(l))throw"Grid : setSelectedRows : cannot set selected rows when somebody else has an edit lock";var d={};for(var e=0;e<c.length;e++)d[c[e]]=!0;for(var e=0;e<E.length;e++){var f=E[e];w[f]&&!d[f]&&b(w[f]).removeClass("selected")}for(var e=0;e<c.length;e++){var f=c[e];w[f]&&!F[f]&&b(w[f]).addClass("selected")}E=c.concat(),F=d}function V(a){if(v&&!bw())return;bn(null),f.enableAddRow!=a.enableAddRow&&ba(d.length),f=b.extend(f,a),bh()}function W(a,b,c,d,e){return c==null||c==undefined?"":c}function X(a,b){var c=d[b],f=b<d.length&&!c,g="r"+(f?" loading":"")+(F[b]?" selected":"");a.push("<div class='"+g+"' row='"+b+"' style='top:"+h*b+"px'>");for(var i=0,j=e.length;i<j;i++){var k=e[i],l;!k.active||!c.active,a.push("<div "+(k.unselectable?"":"hideFocus tabIndex=0 ")+"class='c c"+i+(k.cssClass?" "+k.cssClass:"")+(k.active&&c.active?" active-col-and-row":"")+"' cell="+i+">"),c&&b<d.length&&a.push(k.formatter(b,i,c[k.field],k,c)),a.push("</div>")}a.push("</div>")}function Y(a){var b=[];return X(b,a),b.join("")}function Z(a,b){console.time("cleanupRows");var c=x,d=p[0];for(var e in w)(e<a||e>b)&&e!=s&&(d.removeChild(w[e]),delete w[e],x--,K++);console.log("removed "+(c-x)+" rows"),console.timeEnd("cleanupRows")}function _(){console.log("removeAllRows"),p[0].innerHTML="",w={},K+=x,x=0}function ba(a){var b=w[a];if(!b)return;if(v&&s==a)throw"Grid : removeRow : Cannot remove a row that is currently in edit mode";C=0,b.parentNode.removeChild(b),b=null,delete w[a],x--,K++}function bb(a){console.time("removeRows");if(!a||!a.length)return;C=0;var b=[];for(var c=0,d=a.length;c<d;c++){if(v&&s==c)throw"Grid : removeRow : Cannot remove a row that is currently in edit mode";var e=w[a[c]];if(!e)continue;b.push(a[c])}if(x>10&&b.length==x)p[0].innerHTML="",w={},K+=x,x=0;else for(var c=0,f=b.length;c<f;c++){var e=w[b[c]];e.parentNode.removeChild(e),delete w[b[c]],x--,K++}console.timeEnd("removeRows")}function bc(a,c){if(!w[a])return;var f=b(w[a]).find(".c[cell="+c+"]");if(f.length===0)return;var g=e[c],h=d[a];v&&s==a&&t==c?v.setValue(h[g.field]):f[0].innerHTML=h?g.formatter(a,c,h[g.field],g,h):""}function bd(a){if(!w[a])return;b(w[a]).find(".c").each(function(b){var c=e[b];a==s&&b==t&&v?v.setValue(d[s][c.field]):d[a]?this.innerHTML=c.formatter(a,b,d[a][c.field],c,d[a]):this.innerHTML=""})}function be(){r=o.innerWidth(),q=o.innerHeight(),j=y=Math.ceil(q/h),i=Math.max(i,y+2*j);var a=0;for(var c=0;c<e.length;c++)a+=e[c].width+5;p.width(a);var g=p[0],k=f.enableAddRow?d.length:d.length-1;for(var c in w)c>=k&&(g.removeChild(w[c]),delete w[c],x--,K++);var l=Math.max(h*(d.length+y-2),q-b.getScrollbarWidth());o.scrollTop()>l-o.height()+b.getScrollbarWidth()&&o.scrollTop(l-o.height()+b.getScrollbarWidth()),p.height(l)}function bf(){return{top:Math.floor(A/h),bottom:Math.floor((A+q)/h)}}function bg(a,b){console.time("renderRows");var c=p[0],d=x,e=[],f=[],g=new Date;for(var h=a;h<=b;h++){if(w[h])continue;x++,f.push(h),X(e,h),J++}var i=document.createElement("div");i.innerHTML=e.join("");for(var h=0,j=i.childNodes.length;h<j;h++)w[f[h]]=c.appendChild(i.firstChild);x-d>5&&(D=(new Date-g)/(x-d)),console.log("rendered "+(x-d)+" rows"),console.timeEnd("renderRows")}function bh(){var a=bf(),b=Math.max(0,a.top-(C<0?j:5)),c=Math.min(f.enableAddRow?d.length:d.length-1,a.bottom+(C>0?j:5));x>10&&Math.abs(z-A)>h*i?_():Z(b,c),bg(b,c),z=A,I=null}function bi(){A=o[0].scrollTop;var a=Math.abs(z-A),b=o[0].scrollLeft;b!=B&&(m[0].scrollLeft=B=b);if(a<5*h)return;z==A?C=0:z<A?C=1:C=-1,I&&window.clearTimeout(I),a<y*h?bh():I=window.setTimeout(bh,50),l.onViewportChanged&&l.onViewportChanged()}function bj(b){switch(b.which){case 27:a.isEditing()&&a.hasLock(l)&&bx(l),u&&u.focus();break;case 9:b.shiftKey?bu(0,-1,!0):bu(0,1,!0);break;case 37:bu(0,-1);break;case 39:bu(0,1);break;case 38:bu(-1,0);break;case 40:case 13:bu(1,0);break;default:if(l.onKeyDown&&d[s]&&!v&&l.onKeyDown(b,s,t))return b.stopPropagation(),b.preventDefault(),!1;return}return b.stopPropagation(),b.preventDefault(),!1}function bk(a){var c=b(a.target).closest(".c");if(c.length===0)return;if(u==c[0]&&v!=null)return;var g=parseInt(c.parent().attr("row")),h=parseInt(c.attr("cell")),i=null;if(d[g]&&l.onClick&&(!v||(i=bw()))&&l.onClick(a,g,h))return a.stopPropagation(),a.preventDefault(),!1;f.enableCellNavigation&&!e[h].unselectable&&(i==1||i==null&&bw())&&bo(c[0])}function bl(a){var c=b(a.target).closest(".c");if(c.length===0)return;if(u==c[0]&&v!=null)return;f.editOnDoubleClick&&bs()}function bm(a,b){var c=Math.floor(b/h),d=0,f=0;for(var g=0;g<e.length&&f<b;g++)f+=e[g].width,d++;return{row:c,cell:d-1}}function bn(a,c){u!=null&&(br(),b(u).removeClass("selected")),u=a,u!=null?(s=parseInt(b(u).parent().attr("row")),t=parseInt(b(u).attr("cell")),b(u).addClass("selected"),bt(),f.editable&&!f.editOnDoubleClick&&(d[s]||s==d.length)&&(window.clearTimeout(H),c?H=window.setTimeout(bs,100):bs())):(s=null,t=null)}function bo(a,b){bn(a,b),a?U([s]):U([]),l.onSelectedRowsChanged&&l.onSelectedRowsChanged()}function bp(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){var a=window.getSelection();a&&a.removeAllRanges&&a.removeAllRanges()}}function bq(a,b){return a<d.length&&!d[a]?!1:e[b].cannotTriggerInsert&&a>=d.length?!1:e[b].editor?!0:!1}function br(){if(!v)return;v.destroy(),b(u).removeClass("editable invalid"),d[s]&&(u.innerHTML=e[t].formatter(s,t,d[s][e[t].field],e[t],d[s])),v=null,b.browser.msie&&bp(),a.leaveEditMode(l)}function bs(){if(!u)return;if(!f.editable)throw"Grid : makeSelectedCellEditable : should never get called when options.editable is false";window.clearTimeout(H);if(!bq(s,t))return;a.enterEditMode(l),b(u).addClass("editable");var c=null;d[s]&&(c=d[s][e[t].field]),u.innerHTML="",v=new e[t].editor(b(u),e[t],c,d[s])}function bt(){if(!u)return;var a=o[0].scrollTop;(s+2)*h>a+q?(o[0].scrollTop=s*h,bi()):s*h<a&&(o[0].scrollTop=(s+2)*h-q,bi())}function bu(c,d,e){if(!u)return;if(!f.enableCellNavigation)return;if(!a.commitCurrentEdit())return;var g=w[s+c],h=g?b(g).find(".c[cell="+(t+d)+"][tabIndex=0]"):null;e&&c==0&&!(g&&h&&h.length)&&(!h||!h.length)&&(d>0?(g=w[s+c+1],h=g?b(g).find(".c[cell][tabIndex=0]:first"):null):(g=w[s+c-1],h=g?b(g).find(".c[cell][tabIndex=0]:last"):null)),g&&h&&h.length?(bo(h[0],f.asyncEditorLoading),v||u.focus()):u.focus()}function bv(c,g){if(c>d.length||c<0||g>=e.length||g<0)return;if(!f.enableCellNavigation||e[g].unselectable)return;if(!a.commitCurrentEdit())return;w[c]||bg(c,c);var g=b(w[c]).find(".c[cell="+g+"][tabIndex=0]")[0];bo(g),v||u.focus()}function bw(){if(v){if(v.isValueChanged()){var a=v.validate();if(a.valid){var c=v.getValue();return s<d.length?e[t].setValueHandler?e[t].setValueHandler(c,e[t],d[s]):d[s][e[t].field]=c:l.onAddNewRow&&l.onAddNewRow(e[t],c),br(),!0}return b(u).addClass("invalid"),b(u).stop(!0,!0).effect("highlight",{color:"red"},300),l.onValidationError&&l.onValidationError(u,a,s,t,e[t]),v.focus(),!1}br()}return!0}function bx(){br()}var g={enableAddRow:!0,manualScrolling:!1,editable:!0,editOnDoubleClick:!1,enableCellNavigation:!0,defaultColumnWidth:80,enableColumnReorder:!0,asyncEditorLoading:!0},h=24,i=50,j=5,k="slickgrid_"+Math.round(1e6*Math.random()),l=this,m,n,o,p,q,r,s,t,u=null,v=null,w={},x=0,y,z=0,A=0,B=0,C=1,D=10,E=[],F={},G={},H=null,I=null,J=0,K=0,L=document.createDocumentFragment(),M=!1;this.debug=function(){var a="";a+="\ncounter_rows_rendered:  "+J,a+="\ncounter_rows_removed:  "+K,a+="\nrenderedRows:  "+x,a+="\nnumVisibleRows:  "+y,a+="\nCAPACITY:  "+i,a+="\nBUFFER:  "+j,a+="\navgRowRenderTime:  "+D,alert(a)},this.benchmark_render_200=function(){_(),bg(0,200),Z()},this.stressTest=function(){console.time("benchmark-stress"),bg(0,500),Z(),console.timeEnd("benchmark-stress"),window.setTimeout(l.stressTest,50)},this.benchmarkFn=function(a){var b=new Date,c=new Array(arguments);c.splice(0,1),l[a].call(this,c),alert("Grid : benchmarkFn : "+a+" : "+(new Date-b)+"ms")},N(),b.extend(this,{onColumnHeaderClick:null,onClick:null,onKeyDown:null,onAddNewRow:null,onValidationError:null,onViewportChanged:null,onSelectedRowsChanged:null,onColumnsReordered:null,destroy:Q,getColumnIndex:S,updateCell:bc,updateRow:bd,removeRow:ba,removeRows:bb,removeAllRows:_,render:bh,getViewport:bf,resizeCanvas:be,scroll:scroll,getCellFromPoint:bm,gotoCell:bv,editCurrentCell:bs,getSelectedRows:T,setSelectedRows:U,setColumnHeaderCssClass:R,commitCurrentEdit:bw,cancelCurrentEdit:bx})}})