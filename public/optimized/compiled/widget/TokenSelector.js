(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["jquery","jquery.ajaxJSON","jquery.instructure_jquery_patches","jquery.instructure_misc_helpers","jquery.disableWhileLoading","compiled/jquery/scrollIntoView"],function(b){return function(){function c(c,d,e){this.input=c,this.url=d,this.options=e!=null?e:{},this.close=a(this.close,this),this.stack=[],this.fetchListAjaxRequests=[],this.queryCache={},this.$container=b("<div />").addClass("autocomplete_menu"),this.options.showToggles&&this.$container.addClass("with-toggles"),this.$menu=b("<div />").append(this.$list=this.newList()),this.$container.append(b("<div />").append(this.$menu)),this.$container.css("top",0).css("left",0),this.mode="input",b("body").append(this.$container),this.reposition=a(function(){var a;return a=this.input.bottomOffset(),this.$container.css("top",a.top),this.$container.css("left",a.left)},this),b(window).resize(this.reposition),this.close()}return c.prototype.abortRunningRequests=function(){var a,b,c,d;d=this.fetchListAjaxRequests;for(b=0,c=d.length;b<c;b++)a=d[b],a.abort();return this.fetchListAjaxRequests=[]},c.prototype.browse=function(a){if(!this.uiLocked)return this.input.val(""),this.close(),this.fetchList({data:a}),!0},c.prototype.newList=function(){var c;return c=b('<div class="list"><ul class="heading"></ul><ul></ul></div>'),c.find("ul").mousemove(a(function(a){var c;if(this.uiLocked)return;return c=b(a.target).closest("li"),c.hasClass("selectable")||(c=null),this.select(c)},this)).mousedown(a(function(b){return setTimeout(a(function(){return this.input.focus()},this),0)},this)).click(a(function(a){var c;if(this.uiLocked)return;return c=b(a.target).closest("li"),c.hasClass("selectable")||(c=null),this.select(c),this.selection&&(b(a.target).closest("a.expand").length?this.selectionExpanded()?this.collapse():this.expandSelection():this.selectionToggleable()&&b(a.target).closest("a.toggle").length?this.toggleSelection():this.selectionExpanded()?this.collapse():this.selectionExpandable()?this.expandSelection():(this.toggleSelection(!0),this.clear(),this.close())),this.input.focus()},this)),c.body=c.find("ul").last(),c},c.prototype.captureKeyDown=function(a){var b,c;if(this.uiLocked)return!0;switch((b=(c=a.originalEvent)!=null?c.keyIdentifier:void 0)!=null?b:a.which){case"Backspace":case"U+0008":case 8:if(this.input.val()==="")return this.listExpanded()?this.collapse():this.$menu.is(":visible")?this.close():this.input.removeLastToken(),!0;break;case"Tab":case"U+0009":case 9:this.selection&&(this.selectionToggleable()||!this.selectionExpandable())&&this.toggleSelection(!0),this.clear(),this.close();if(this.selection)return!0;break;case"Enter":case 13:if(this.selectionExpanded())return this.collapse(),!0;if(this.selectionExpandable()&&!this.selectionToggleable())return this.expandSelection(),!0;return this.selection&&(this.toggleSelection(!0),this.clear()),this.close(),!0;case"Shift":case 16:return!1;case"Esc":case"U+001B":case 27:return this.$menu.is(":visible")?(this.close(),!0):!1;case"U+0020":case 32:if(this.selectionToggleable()&&this.mode==="menu")return this.toggleSelection(),!0;break;case"Left":case 37:if(this.listExpanded()&&this.input.caret()===0)return this.selectionExpanded()||this.input.val()===""?this.collapse():this.select(this.$list.find("li").first()),!0;break;case"Up":case 38:return this.selectPrev(),!0;case"Right":case 39:if(this.input.caret()===this.input.val().length&&this.expandSelection())return!0;break;case"Down":case 40:return this.selectNext(),!0;case"U+002B":case 187:case 107:if(this.selectionToggleable()&&this.mode==="menu")return this.toggleSelection(!0),!0;break;case"U+002D":case 189:case 109:if(this.selectionToggleable()&&this.mode==="menu")return this.toggleSelection(!1),!0}return this.mode="input",this.fetchList(),!1},c.prototype.fetchList=function(c,d){return c==null&&(c={}),this.uiLocked=d!=null?d:!1,clearTimeout(this.timeout),this.timeout=setTimeout(a(function(){var d,e,f;d=this.preparePost((f=c.data)!=null?f:{}),e=JSON.stringify(d);if(d.search===""&&!this.listExpanded()&&!c.data){this.uiLocked=!1,this.close();return}if(e===this.lastAppliedQuery){this.uiLocked=!1;return}if(this.queryCache[e]){this.lastAppliedQuery=e,this.lastSearch=d.search,this.abortRunningRequests(),this.renderList(this.queryCache[e],c,d);return}return this.fetchListAjaxRequests.push(this.load(b.ajaxJSON(this.url,"POST",b.extend({},d),a(function(a){var b;this.queryCache[e]=a;if(JSON.stringify(this.preparePost((b=c.data)!=null?b:{}))!==e)return this.uiLocked=!1;this.lastAppliedQuery=e,this.lastSearch=d.search;if(this.$menu.is(":visible"))return this.renderList(a,c,d)},this),a(function(a){return this.uiLocked=!1},this))))},this),100)},c.prototype.addByUserId=function(c,d){var e;return e=a(function(a){var b;this.close(),b=a[0];if(b)return this.input.addToken({value:b.id,text:b.name,data:b})},this),this.load(b.ajaxJSON(this.url,"POST",{user_id:c,from_conversation_id:d},e,this.close))},c.prototype.open=function(){return this.$container.show(),this.reposition()},c.prototype.close=function(){var a,b,c,d,e,f,g,h;this.uiLocked=!1,this.$container.hide(),delete this.lastAppliedQuery,g=this.stack;for(c=0,f=g.length;c<f;c++)h=g[c],b=h[0],a=h[1],d=h[2],e=h[3],this.$list.remove(),this.$list=a.css("height","auto");return this.$list.find("ul").html(""),this.stack=[],this.$menu.css("left",0),this.select(null),this.input.selectorClosed()},c.prototype.clear=function(){return this.input.val("")},c.prototype.blur=function(){return this.close()},c.prototype.listExpanded=function(){return this.stack.length?!0:!1},c.prototype.selectionExpanded=function(){var a,b;return(a=(b=this.selection)!=null?b.hasClass("expanded"):void 0)!=null?a:!1},c.prototype.selectionExpandable=function(){var a,b;return(a=(b=this.selection)!=null?b.hasClass("expandable"):void 0)!=null?a:!1},c.prototype.selectionToggleable=function(a){var b;return a==null&&(a=this.selection),((b=a!=null?a.hasClass("toggleable"):void 0)!=null?b:!1)&&!this.selectionExpanded()},c.prototype.expandSelection=function(){return!this.selectionExpandable()||!!this.selectionExpanded()?!1:(this.stack.push([this.selection,this.$list,this.lastAppliedQuery,this.lastSearch]),this.clear(),this.$menu.css("width",(this.stack.length+1)*100+"%"),this.fetchList({expand:!0},!0))},c.prototype.collapse=function(){var b,c,d;return this.listExpanded()?(d=this.stack.pop(),c=d[0],b=d[1],this.lastAppliedQuery=d[2],this.lastSearch=d[3],this.uiLocked=!0,b.css("height","auto"),this.$menu.animate({left:"+="+this.$menu.parent().css("width")},"fast",a(function(){return this.input.val(this.lastSearch),this.$list.remove(),this.$list=b,this.select(c),this.uiLocked=!1},this))):!1},c.prototype.toggleSelection=function(a,b,c){var d,e;b==null&&(b=this.selection),c==null&&(c=!1);if(a==null&&!this.selectionToggleable(b))return!1;d=b.data("id"),a==null&&(a=!b.hasClass("on")),a?(this.selectionToggleable(b)&&!c&&b.addClass("on"),this.input.addToken({value:d,text:(e=b.data("text"))!=null?e:b.text(),noClear:!0,data:b.data("user_data")})):(c||b.removeClass("on"),this.input.removeToken({value:d}));if(!c)return this.updateSelectAll(b)},c.prototype.updateSelectAll=function(c,d){var e,f,g,h,i,j;d==null&&(d=0),j=c.data("user_data").selectAll,e=d?this.stack[this.stack.length-d][1]:this.$list,i=e.selectAll;if(!i)return;f=e.body.find("li.toggleable").not(i),j?i.hasClass("on")?f.addClass("on").each(a(function(a,c){return this.toggleSelection(!1,b(c),!0)},this)):f.removeClass("on").each(a(function(a,c){return this.toggleSelection(!1,b(c),!0)},this)):(g=f.filter(".on"),g.length<f.length&&i.hasClass("on")?(i.removeClass("on"),this.toggleSelection(!1,i,!0),g.each(a(function(a,c){return this.toggleSelection(!0,b(c),!0)},this))):g.length===f.length&&!i.hasClass("on")&&(i.addClass("on"),this.toggleSelection(!0,i,!0),g.each(a(function(a,c){return this.toggleSelection(!1,b(c),!0)},this))));if(d<this.stack.length){d++,h=this.stack[this.stack.length-d][0];if(this.selectionToggleable(h))return i.hasClass("on")?h.addClass("on"):h.removeClass("on"),this.updateSelectAll(h,d)}},c.prototype.select=function(a,b){var c,d;b==null&&(b=!1);if((a!=null?a[0]:void 0)===((c=this.selection)!=null?c[0]:void 0))return;(d=this.selection)!=null&&d.removeClass("active"),this.selection=(a!=null?a.length:void 0)?(a.addClass("active"),a.scrollIntoView({ignore:{border:!0}}),a):null;if(!b)return this.mode=a?"menu":"input"},c.prototype.selectNext=function(a){var b;a==null&&(a=!1),this.select(this.selection?this.selection.next().length?this.selection.next():this.selection.parent("ul").next().length?this.selection.parent("ul").next().find("li").first():null:this.$list.find("li:first"),a);if((b=this.selection)!=null?b.hasClass("message"):void 0)return this.selectNext(a)},c.prototype.selectPrev=function(){var a,b;this.select(this.selection?((a=this.selection)!=null?a.prev().length:void 0)?this.selection.prev():this.selection.parent("ul").prev().length?this.selection.parent("ul").prev().find("li").last():null:this.$list.find("li:last"));if((b=this.selection)!=null?b.hasClass("message"):void 0)return this.selectPrev()},c.prototype.populateRow=function(a,b,c){c==null&&(c={}),this.options.populator?this.options.populator(this,a,b,c):(a.data("id",b.text),a.text(b.text)),c.first&&a.addClass("first");if(c.last)return a.addClass("last")},c.prototype.load=function(a){return this.$menu.is(":visible")||(this.open(),this.$list.find("ul").last().append(b('<li class="message first last"></li>'))),this.$list.disableWhileLoading(a),a},c.prototype.renderList=function(c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;d==null&&(d={}),e==null&&(e={}),this.open(),d.expand?i=this.newList():i=this.$list,i.selectAll=null,this.selection=null,k=i.find("ul"),k.html(""),g=k.first(),f=k.last();if(c.length){o=this.stack.length?this.stack[this.stack.length-1][0]:null,m=this.stack.length?function(){var a,b,c,d;c=this.stack,d=[];for(a=0,b=c.length;a<b;a++)l=c[a],d.push(l[0].data("id"));return d}.call(this):[],c.prepared||(typeof (q=this.options).preparer=="function"&&q.preparer(e,c,o),c.prepared=!0);for(n=0,s=c.length;n<s;n++)p=c[n],h=b("<li />").addClass("selectable"),this.populateRow(h,p,{level:this.stack.length,first:n===0,last:n===c.length-1,parent:o,ancestors:m}),p.selectAll&&(i.selectAll=h),h.hasClass("toggleable")&&this.input.hasToken(h.data("id"))&&h.addClass("on"),f.append(h);(((t=i.selectAll)!=null?typeof t.hasClass=="function"?t.hasClass("on"):void 0:void 0)||this.stack.length&&(typeof (r=this.stack[this.stack.length-1][0]).hasClass=="function"?r.hasClass("on"):void 0))&&i.body.find("li.toggleable").addClass("on")}else j=b('<li class="message first last"></li>'),j.text((u=(v=this.options.messages)!=null?v.noResults:void 0)!=null?u:""),f.append(j);return this.listExpanded()?(h=this.stack[this.stack.length-1][0].clone(),h.addClass("expanded").removeClass("active first last"),g.append(h).show()):g.hide(),d.expand?(i.insertAfter(this.$list),this.$menu.animate({left:"-="+this.$menu.parent().css("width")},"fast",a(function(){return this.$list.animate({height:"1px"},"fast",a(function(){return this.uiLocked=!1},this)),this.$list=i,this.selectNext(!0)},this))):(d.loading||this.selectNext(!0),this.uiLocked=!1)},c.prototype.preparePost=function(a){var c,d,e,f;return c=b.extend({},(e=this.options.baseData)!=null?e:{},a,{search:this.input.val().replace(/^\s+|\s+$/g,"")}),c.exclude=this.input.baseExclude.concat(this.stack.length?[]:this.input.tokenValues()),this.listExpanded()&&(c.context=this.stack[this.stack.length-1][0].data("id")),(f=c.per_page)==null&&(c.per_page=typeof (d=this.options).limiter=="function"?d.limiter({level:this.stack.length}):void 0),c},c}()})}).call(this)