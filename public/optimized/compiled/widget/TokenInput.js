(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1};define(["jquery","compiled/widget/TokenSelector","jquery.instructure_jquery_patches","jquery.instructure_misc_plugins"],function(c,d){var e;return e=function(){function e(b,e){var f,g;this.$node=b,this.options=e,this.$node.data("token_input",this),this.$fakeInput=c("<div />").css("font-family",this.$node.css("font-family")).insertAfter(this.$node).addClass("token_input").click(a(function(){return this.$input.focus()},this)),this.nodeName=this.$node.attr("name"),this.$node.removeAttr("name").hide().change(a(function(){return this.$tokens.html(""),typeof this.change=="function"?this.change(this.tokenValues()):void 0},this)),this.added=this.options.added,this.$placeholder=c("<span />"),this.$placeholder.text(this.options.placeholder),this.options.placeholder&&this.$placeholder.appendTo(this.$fakeInput),this.$scroller=c("<div />").appendTo(this.$fakeInput),this.$tokens=c("<ul />").appendTo(this.$scroller),this.$tokens.click(a(function(a){var b,d;if(d=c(a.target).closest("li")){b=c(a.target).closest("a");if(b.length)return d.remove(),typeof this.change=="function"?this.change(this.tokenValues()):void 0}},this)),this.$tokens.maxTokenWidth=a(function(){var a;return parseInt(this.$tokens.css("width").replace("px",""))-((a=this.options.tokenWrapBuffer)!=null?a:150)+"px"},this),this.$tokens.resizeTokens=a(function(a){return a.find("div.ellipsis").css("max-width",this.$tokens.maxTokenWidth())},this),c(window).resize(a(function(){return this.$tokens.resizeTokens(this.$tokens)},this)),this.$input=c("<input />").appendTo(this.$scroller).css("width","20px").css("font-size",this.$fakeInput.css("font-size")).autoGrowInput({comfortZone:20}).focus(a(function(){return this.$placeholder.hide(),this.active=!0,this.$fakeInput.addClass("active")},this)).blur(a(function(){return this.active=!1,setTimeout(a(function(){var a;if(!this.active)return this.$fakeInput.removeClass("active"),this.$placeholder.showIf(this.val()===""&&!this.$tokens.find("li").length),(a=this.selector)!=null?typeof a.blur=="function"?a.blur():void 0:void 0},this),50)},this)).keydown(a(function(a){return this.inputKeyDown(a)},this)).keyup(a(function(a){return this.inputKeyUp(a)},this));if(this.options.selector){f=(g=this.options.selector.type)!=null?g:d,delete this.options.selector.type;if(this.browser=this.options.selector.browser)delete this.options.selector.browser,c('<a class="browser">browse</a>').click(a(function(){if(this.selector.browse(this.browser.data))return this.$fakeInput.addClass("browse")},this)).prependTo(this.$fakeInput),this.$fakeInput.addClass("browsable");this.selector=new f(this,this.$node.attr("finder_url"),this.options.selector)}this.baseExclude=[],this.resize()}return e.prototype.resize=function(){return this.$fakeInput.css("width",this.$node.css("width"))},e.prototype.addToken=function(a){var b,d,e,f,g,h,i,j,k;return i=(j=a!=null?a.value:void 0)!=null?j:this.val(),f="token_"+i,e=this.$tokens.find("#"+f),g=e.length===0,g&&(e=c("<li />"),h=(k=a!=null?a.text:void 0)!=null?k:this.val(),e.attr("id",f),d=c("<div />").addClass("ellipsis"),d.attr("title",h),d.text(h),e.append(d),b=c("<a />"),e.append(b),e.append(c("<input />").attr("type","hidden").attr("name",this.nodeName+"[]").val(i)),this.$tokens.resizeTokens(e),this.$tokens.append(e)),(a!=null?!a.noClear:!void 0)&&this.val(""),this.$placeholder.hide(),a&&typeof this.added=="function"&&this.added(a.data,e,g),typeof this.change=="function"&&this.change(this.tokenValues()),this.reposition()},e.prototype.hasToken=function(a){var b;return this.$tokens.find("#token_"+((b=a!=null?a.value:void 0)!=null?b:a)).length>0},e.prototype.removeToken=function(a){var b,c;return b="token_"+((c=a!=null?a.value:void 0)!=null?c:a),this.$tokens.find("#"+b).remove(),typeof this.change=="function"&&this.change(this.tokenValues()),this.reposition()},e.prototype.removeLastToken=function(a){return this.$tokens.find("li").last().remove(),typeof this.change=="function"&&this.change(this.tokenValues()),this.reposition()},e.prototype.reposition=function(){var a;return(a=this.selector)!=null&&a.reposition(),this.$scroller.scrollTop(this.$scroller.prop("scrollHeight"))},e.prototype.inputKeyDown=function(a){var c,d,e;this.keyUpAction=!1;if(this.selector){if((c=this.selector)!=null?c.captureKeyDown(a):void 0)return a.preventDefault(),!1;this.$fakeInput.removeClass("browse")}else if((d=(e=a.which,b.call(this.delimiters,e)>=0))!=null?d:[])return this.keyUpAction=this.addToken,a.preventDefault(),!1;return!0},e.prototype.tokenValues=function(){var a,b,c,d,e;d=this.$tokens.find("input"),e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.value);return e},e.prototype.inputKeyUp=function(a){return this.reposition(),typeof this.keyUpAction=="function"?this.keyUpAction():void 0},e.prototype.bottomOffset=function(){var a;return a=this.$fakeInput.offset(),a.top+=this.$fakeInput.height()+2,a},e.prototype.focus=function(){return this.$input.focus()},e.prototype.val=function(a){if(a==null)return this.$input.val();if(a!==this.$input.val())return this.$input.val(a).change(),this.reposition()},e.prototype.caret=function(){var a,b,c,d;return this.$input[0].selectionStart!=null?(c=this.$input[0].selectionStart,a=this.$input[0].selectionEnd):(d=this.val(),b=document.selection.createRange().duplicate(),b.moveEnd("character",d.length),c=b.text===""?d.length:d.lastIndexOf(b.text),b=document.selection.createRange().duplicate(),b.moveStart("character",-d.length),a=b.text.length),c===a?c:-1},e.prototype.selectorClosed=function(){return this.$fakeInput.removeClass("browse")},e}(),c.fn.tokenInput=function(a){return this.each(function(){return new e(c(this),c.extend(!0,{},a))})}})}).call(this)