(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["i18n!calendar","jst/calendar/messageParticipants","jst/calendar/recipientList"],function(b,c,d){var e;return e=function(){function e(b,d){this.group=b,this.dataSource=d,this.messageFailed=a(this.messageFailed,this),this.messageSent=a(this.messageSent,this),this.sendMessage=a(this.sendMessage,this),this.loadParticipants=a(this.loadParticipants,this),this.$form=$(c(this.group)).submit(this.sendMessage),this.$select=this.$form.find("select.message_groups").change(this.loadParticipants).val("unregistered"),this.$participantList=this.$form.find("ul")}return e.prototype.show=function(){return this.$form.dialog({width:400,resizable:!1,buttons:[{text:b.t("buttons.send_message","Send"),"data-text-while-loading":b.t("buttons.sending_message","Sending..."),click:function(){return $(this).submit()}},{text:b.t("buttons.cancel","Cancel"),click:function(){return $(this).dialog("close")}}],close:function(){return $(this).remove()}}),this.loadParticipants()},e.prototype.participantStatus=function(a){var b;return a==null&&(a=null),b=$('<li class="status" />'),this.$participantList.html(b),a?b.text(a):b.spin()},e.prototype.loadParticipants=function(){var c;return c=this.$select.val(),this.loading=!0,this.participantStatus(),this.dataSource.getParticipants(this.group,c,a(function(a){var c;return delete this.loading,a.length?this.$participantList.html(d({recipientType:this.group.participant_type,recipients:a})):(c=this.group.participant_type==="Group"?b.t("no_groups","No groups found"):b.t("no_users","No users found"),this.participantStatus(c))},this))},e.prototype.sendMessage=function(a){var b,c;a.preventDefault();if(this.loading)return;b=this.$form.getFormData();if(!b["recipients[]"]||!b.body)return;return c=$.ajaxJSON("/conversations","POST",b,this.messageSent,this.messageFailed),this.$form.disableWhileLoading(c,{buttons:["[data-text-while-loading] .ui-button-text"]})},e.prototype.messageSent=function(a){return this.$form.dialog("close"),$.flashMessage(b.t("messages_sent","Messages Sent"))},e.prototype.messageFailed=function(a){return this.$form.find(".error").text(b.t("errors.send_message_failed","There was an error sending your message, please try again"))},e}()})}).call(this)