(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["jquery","i18n!EditAppointmentGroupDetails","compiled/calendar/TimeBlockList","jst/calendar/editAppointmentGroup","jst/calendar/genericSelect","jquery.ajaxJSON","jquery.disableWhileLoading","jquery.instructure_forms"],function(b,c,d,e,f){var g;return g=function(){function g(c,f,g,h){var i,j,k,l,m;this.apptGroup=f,this.contextChangeCB=g,this.closeCB=h,this.contextChange=a(this.contextChange,this),this.save=a(this.save,this),this.saveClick=a(this.saveClick,this),this.saveWithoutPublishingClick=a(this.saveWithoutPublishingClick,this),this.currentContextInfo=null,b(c).html(e({title:this.apptGroup.title,contexts:this.apptGroup.contexts,appointment_group:this.apptGroup})),this.form=b(c).find("form"),this.form.find("select.context_id").change(this.contextChange).change(),this.apptGroup.id?(this.form.attr("action",this.apptGroup.url),this.form.find(".context_id").val(this.apptGroup.context_code).attr("disabled",!0),this.form.find("select.context_id").change(),this.form.find(".group_category").attr("disabled",!0),this.form.find(".course_section").attr("disabled",!0),this.form.find(".group-signup-checkbox").attr("disabled",!0),this.apptGroup.participant_type==="Group"?(this.form.find(".group-signup-checkbox").prop("checked",!0),this.form.find(".group_category").val(this.apptGroup.sub_context_code)):(this.form.find(".group-signup-checkbox").prop("checked",!1),this.apptGroup.sub_context_code?this.form.find(".course_section").val(this.apptGroup.sub_context_code):this.form.find(".course_section").val("all"))):this.form.attr("action",this.currentContextInfo.create_appointment_group_url),m=function(){var a,b,c,d;c=this.apptGroup.appointmentEvents||[],d=[];for(a=0,b=c.length;a<b;a++)i=c[a],d.push([i.start,i.end,!0]);return d}.call(this),this.timeBlockList=new d(this.form.find(".time-block-list-body"),this.form.find(".splitter"),m),this.form.find('[name="slot_duration"]').change(a(function(a){if(this.form.find('[name="autosplit_option"]').is(":checked"))return this.timeBlockList.split(a.target.value),this.timeBlockList.render()},this)),this.form.find('[name="participant_visibility"]').prop("checked",this.apptGroup.participant_visibility==="protected"),this.form.find(".group-signup-checkbox").change(a(function(a){var b;return b=!!a.target.checked,this.form.find(".per_appointment_groups_label").toggle(b),this.form.find(".per_appointment_users_label").toggle(!b),this.form.find(".section-signup").toggle(!b),this.form.find(".group-signup").toggle(b)},this)),this.form.find(".group-signup-checkbox").change(),this.form.find('[name="per_slot_option"]').change(a(function(a){var b,c;b=a.target,c=this.form.find('[name="participants_per_appointment"]');if(!b.checked)return c.attr("disabled",!0);c.attr("disabled",!1);if(c.val()==="")return c.val("1")},this)),this.apptGroup.participants_per_appointment>0?(this.form.find('[name="per_slot_option"]').prop("checked",!0),this.form.find('[name="participants_per_appointment"]').val(this.apptGroup.participants_per_appointment)):this.form.find('[name="participants_per_appointment"]').attr("disabled",!0),l=this.form.find('[name="max_appointments_per_participant"]'),j=this.apptGroup.max_appointments_per_participant||1,l.val(j),k=this.form.find("#max-per-student-option"),k.change(function(){return l.prop("disabled",!k.prop("checked"))}),j>0?k.prop("checked",!0):l.attr("disabled",!0),this.apptGroup.workflow_state==="active"&&this.form.find("#appointment-blocks-active-button").attr("disabled",!0).prop("checked",!0)}return g.prototype.contextInfoForCode=function(a){var b,c,d,e;e=this.apptGroup.contexts;for(c=0,d=e.length;c<d;c++){b=e[c];if(b.asset_string===a)return b}return null},g.prototype.saveWithoutPublishingClick=function(a){return a.preventDefault(),this.save(!1)},g.prototype.saveClick=function(a){return a.preventDefault(),this.save(!0)},g.prototype.save=function(d){var e,f,g,h,i,j,k,l,m,n,o;f=this.form.getFormData({object_name:"appointment_group"}),e=this.apptGroup.id===void 0,k={"appointment_group[title]":f.title,"appointment_group[description]":f.description,"appointment_group[location_name]":f.location};if(f.max_appointments_per_participant_option){if(f.max_appointments_per_participant<1)return b('[name="max_appointments_per_participant"]').errorBox(c.t("bad_max_appts","You must allow at least one appointment per participant")),!1;k["appointment_group[max_appointments_per_participant]"]=f.max_appointments_per_participant}else k["appointment_group[max_appointments_per_participant]"]="";k["appointment_group[new_appointments]"]=[];if(!this.timeBlockList.validate())return!1;o=this.timeBlockList.blocks();for(m=0,n=o.length;m<n;m++)l=o[m],k["appointment_group[new_appointments]"].push([b.dateToISO8601UTC(b.unfudgeDateForProfileTimezone(l[0])),b.dateToISO8601UTC(b.unfudgeDateForProfileTimezone(l[1]))]);return f.per_slot_option==="1"&&f.participants_per_appointment&&(k["appointment_group[participants_per_appointment]"]=f.participants_per_appointment),d&&this.apptGroup.workflow_state!=="active"&&(k["appointment_group[publish]"]="1"),k["appointment_group[participant_visibility]"]=f.participant_visibility==="1"?"protected":"private",e&&(k["appointment_group[context_code]"]=f.context_code,f.use_group_signup==="1"&&f.group_category_id?k["appointment_group[sub_context_code]"]=f.group_category_id:f.section_id&&f.section_id!=="all"&&(k["appointment_group[sub_context_code]"]=f.section_id),k["appointment_group[min_appointments_per_participant]"]=1),j=a(function(){return this.closeCB(!0)},this),i=a(function(){},this),h=this.apptGroup.id?"PUT":"POST",g=b.ajaxJSON(this.form.attr("action"),h,k,j,i),this.form.disableWhileLoading(g)},g.prototype.contextChange=function(a){var c,d,e;c=b(a.target).val(),this.currentContextInfo=this.contextInfoForCode(c),this.apptGroup.contextInfo=this.currentContextInfo;if(this.currentContextInfo===null)return;this.currentContextInfo.course_sections&&(e={cssClass:"course_section",name:"section_id",collection:[{id:"all",name:"All Sections"}].concat(this.currentContextInfo.course_sections)},this.form.find(".section_select").html(f(e))),!this.currentContextInfo.group_categories||this.currentContextInfo.group_categories.length===0?this.form.find(".group-signup-checkbox").attr("disabled",!0).prop("checked",!1).change():this.currentContextInfo.group_categories&&(this.form.find(".group-signup-checkbox").attr("disabled",!1),d={cssClass:"group_category",name:"group_category_id",collection:this.currentContextInfo.group_categories},this.form.find(".group_select").html(f(d))),this.contextChangeCB(c);if(!this.apptGroup.id)return this.form.attr("action",this.currentContextInfo.create_appointment_group_url)},g}()})}).call(this)