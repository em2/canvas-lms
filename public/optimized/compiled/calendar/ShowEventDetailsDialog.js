(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};define(["jquery","i18n!calendar","compiled/util/Popover","compiled/calendar/CommonEvent","compiled/calendar/EditEventDetailsDialog","jst/calendar/eventDetails","jst/calendar/deleteItem","jst/calendar/reservationOverLimitDialog","use!underscore","jquery.ajaxJSON","jquery.instructure_misc_helpers","jquery.instructure_misc_plugins","vendor/jquery.ba-tinypubsub"],function(b,c,d,e,f,g,h,i,j){var k;return k=function(){function e(b){this.show=a(this.show,this),this.cancelAppointment=a(this.cancelAppointment,this),this.unreserveEvent=a(this.unreserveEvent,this),this.reserveEvent=a(this.reserveEvent,this),this.reserveSuccessCB=a(this.reserveSuccessCB,this),this.reserveErrorCB=a(this.reserveErrorCB,this),this.deleteEvent=a(this.deleteEvent,this),this.showEditDialog=a(this.showEditDialog,this),this.event=b,this.contexts=b.contexts}return e.prototype.showEditDialog=function(){return this.popover.hide(),(new f(this.event)).show()},e.prototype.deleteEvent=function(d){var e;d==null&&(d=this.event);if(this.event.isNewEvent())return;return e=d.object.url,d.object.assignment&&(e=b.replaceTags(this.event.deleteURL,"id",this.event.object.id)),b("<div />").confirmDelete({url:e,message:b(h({message:d.deleteConfirmation,hide_reason:d.object.workflow_state!=="locked"})),dialog:{title:c.t("confirm_deletion","Confirm Deletion")},prepareData:a(function(a){return{cancel_reason:a.find("#cancel_reason").val()}},this),confirmed:a(function(){return this.popover.hide(),b.publish("CommonEvent/eventDeleting",d)},this),success:a(function(){return b.publish("CommonEvent/eventDeleted",d)},this)})},e.prototype.reserveErrorCB=function(d){var e,f,g,h,j;for(h=0,j=d.length;h<j;h++)f=d[h],f.message==="participant has met per-participant limit"&&(g=!0,f.reschedulable=f.reservations.length===1,e=b(i(f)).dialog({resizable:!1,width:450,buttons:f.reschedulable?[{text:c.t("reschedule","Reschedule"),"class":"ui-button-primary",click:a(function(){return e.disableWhileLoading(this.reserveEvent({cancel_existing:!0}).always(function(){return e.dialog("close")}))},this)},{text:c.t("do_nothing","Do Nothing"),click:function(){return e.dialog("close")}}]:[{text:c.t("ok","OK"),click:function(){return e.dialog("close")}}]}));if(!g)return alert("Could not reserve event: "+d),b.publish("CommonEvent/eventSaveFailed",this.event)},e.prototype.reserveSuccessCB=function(a){return this.popover.hide(),b.publish("CommonEvent/eventSaved",this.event)},e.prototype.reserveEvent=function(a){return a==null&&(a={}),b.publish("CommonEvent/eventSaving",this.event),b.ajaxJSON(this.event.object.reserve_url,"POST",a,this.reserveSuccessCB,this.reserveErrorCB)},e.prototype.unreserveEvent=function(){var a,b,c,d,e;d=this.event.childEvents;for(b=0,c=d.length;b<c;b++){a=d[b];if((e=a.object)!=null?e.own_reservation:void 0){this.deleteEvent(a);return}}},e.prototype.cancelAppointment=function(d){var e,f,g;return f=d.data("url"),e=j.detect(this.event.calendarEvent.child_events,function(a){return a.url===f}),b("<div/>").confirmDelete({url:f,message:b(h({message:c.t("cancel_appointment","Are you sure you want to cancel your appointment with %{name}?",{name:((g=e.user)!=null?g.short_name:void 0)||e.group.name})})),dialog:{title:c.t("confirm_removal","Confirm Removal"),width:"400px",resizable:!1},prepareData:a(function(a){return{cancel_reason:a.find("#cancel_reason").val()}},this),success:a(function(){var a,c;this.event.object.child_events=j(this.event.object.child_events).reject(function(a){return a.url===d.data("url")}),d.remove(),c=b("#scheduler").prop("checked"),a=this.event.calendarEvent.child_events;if(!c&&a.length===0)return b.publish("CommonEvent/eventDeleted",this.event),this.popover.hide()},this)})},e.prototype.show=function(c){var e,f,h,i,j,k,l,m,n,o,p,q,r,s,t;f=b.extend(!0,{},this.event,{can_reserve:(k=this.event.object)!=null?k.reserve_url:void 0}),this.event.contextInfo.can_create_appointment_groups&&(f.can_reserve=!1);if((m=this.event.object)!=null?m.child_events:void 0){this.event.object.reserved&&(f.can_unreserve=!0,f.can_reserve=!1),n=this.event.object.child_events;for(i=0,j=n.length;i<j;i++)e=n[i],h={id:((o=e.user)!=null?o.id:void 0)||e.group.id,name:((p=e.user)!=null?p.short_name:void 0)||e.group.name,event_url:e.url},((q=f.reservations)!=null?q:f.reservations=[]).push(h),e.user&&((r=f.reserved_users)!=null?r:f.reserved_users=[]).push(h),e.group&&((s=f.reserved_groups)!=null?s:f.reserved_groups=[]).push(h)}return((t=this.event.object)!=null?t.available_slots:void 0)===0?(f.can_reserve=!1,f.availableSlotsText="None"):((l=this.event.object)!=null?l.available_slots:void 0)>0&&(f.availableSlotsText=this.event.object.available_slots),this.popover=new d(c,g(f)),this.popover.el.find(".edit_event_link").click(a(function(a){return a.preventDefault(),this.showEditDialog()},this)),this.popover.el.find(".delete_event_link").click(a(function(a){return a.preventDefault(),this.deleteEvent()},this)),this.popover.el.find(".reserve_event_link").click(a(function(a){return a.preventDefault(),this.reserveEvent()},this)),this.popover.el.find(".unreserve_event_link").click(a(function(a){return a.preventDefault(),this.unreserveEvent()},this)),this.popover.el.find(".cancel_appointment_link").click(a(function(a){var c;return a.preventDefault(),c=b(a.target).closest("li"),this.cancelAppointment(c)},this))},e}()})}).call(this)