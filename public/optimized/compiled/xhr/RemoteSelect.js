(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=Array.prototype.slice;define(["use!underscore","compiled/class/cache","vendor/spin","jst/util/select/optgroups","jst/util/select/options"],function(c,d,e,f,g){var h;return h=function(){function h(b,e){this.el=b,this.options=e,this.stopSpinner=a(this.stopSpinner,this),this.startSpinner=a(this.startSpinner,this),this.currentKey=a(this.currentKey,this),this.onResponse=a(this.onResponse,this),this.options=c.extend({},this.defaultOptions,this.options),this.options.cache&&$.extend(!0,this,d),this.body=$("body"),this.options.placeholder=this.el.html(),this.options.start===!0&&this.makeRequest()}return h.prototype.defaultOptions={cache:!0,formatter:function(a){return a},requestParams:{},start:!0,url:window.location.href},h.prototype.spinnerOptions={lines:10,length:3,radius:3,speed:1,trail:60,width:2},h.prototype.makeRequest=function(b){var d;b==null&&(b={}),b=c.extend({},this.options.requestParams,b),this.el.prop("disabled",!0);if(this.options.cache)if(d=this.cache.get([this.options.url,b]))return this.onResponse(d);return this.startSpinner(),this.currentRequest=$.getJSON(this.options.url,b,this.onResponse),c.tap(this.currentRequest,a(function(a){return a.url=this.options.url,a.params=b,a.error(this.stopSpinner)},this))},h.prototype.onResponse=function(a){var b,c;return b=this.options.formatter(a),c=this.getTemplate(b),this.shouldCache(this.currentKey())&&this.cache.set(this.currentKey(),a),this.el.empty().append(this.options.placeholder).append(c(b)),this.stopSpinner(),this.el.prop("disabled",!1)},h.prototype.currentKey=function(){return[this.options.url,this.currentRequest.params]},h.prototype.shouldCache=function(){var a;return a=1>arguments.length?[]:b.call(arguments,0),this.options.cache&&!this.cache.get(a)},h.prototype.getTemplate=function(a){return c.isArray(a)?g:f},h.prototype.startSpinner=function(){return this.spinner=$((new e(this.spinnerOptions)).spin().el),this.spinner.css(this.toTheRightOf(this.el)),this.body.append(this.spinner)},h.prototype.stopSpinner=function(){return this.spinner.remove()},h.prototype.toTheRightOf=function(a){return this.spinnerCss||(this.spinnerCss={left:a.offset().left+a.width()+10,position:"absolute",top:a.offset().top+a.height()/2,zIndex:9999})},h}()})}).call(this)