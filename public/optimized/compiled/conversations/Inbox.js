(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1};define(["i18n!conversations","jquery","str/htmlEscape","compiled/conversations/introSlideshow","compiled/widget/TokenInput","compiled/str/TextHelper","compiled/jquery/scrollIntoView","jquery.ajaxJSON","jquery.instructure_date_and_time","jquery.instructure_forms","jquery.instructure_jquery_patches","jquery.instructure_misc_helpers","jquery.disableWhileLoading","jquery.rails_flash_notifications","media_comments","vendor/jquery.ba-hashchange","vendor/jquery.elastic","vendor/jquery.pageless","jqueryui/position"],function(c,d,f,g,h,i){return function(){function h(b){this.options=b,this.initializeMenus=a(this.initializeMenus,this),this.currentUser=this.options.USER,this.contexts=this.options.CONTEXTS,this.scope=this.options.SCOPE,this.userCache={},this.userCache[this.currentUser.id]=this.currentUser,d(a(function(){return this.render()},this))}return h.prototype.render=function(){this.$inbox=d("#inbox"),this.minHeight=parseInt(this.$inbox.css("min-height").replace("px","")),this.$conversations=d("#conversations"),this.$conversationList=this.$conversations.find("ul.conversations"),this.$messages=d("#messages"),this.$messageList=this.$messages.find("ul.messages"),this.initializeHelp(),this.initializeForms(),this.initializeMenus(),this.initializeMessageActions(),this.initializeConversationActions(),this.initializeTemplates(),this.initializeTokenInputs(),this.initializeConversationsPane(this.options.INITIAL_CONVERSATIONS),this.initializeAutoResize(),this.initializeHashChange();if(this.options.SHOW_INTRO)return g()},h.prototype.showMessageForm=function(){var a;return a=this.$selectedConversation==null,this.$form.find("#recipient_info").showIf(a),this.$form.find("#group_conversation_info").hide(),d("#action_compose_message").toggleClass("active",a),a?(this.$form.find(".audience").html(c.t("headings.new_message","New Message")),this.$form.addClass("new"),this.$form.find("#action_add_recipients").hide(),this.$form.attr({action:"/conversations"})):(this.buildFormAudience(),this.$form.removeClass("new"),this.$form.find("#action_add_recipients").showIf(!this.$selectedConversation.hasClass("private")),this.$form.attr({action:this.$selectedConversation.find("a.details_link").attr("add_url")})),this.resetMessageForm(),this.$form.find("#user_note_info").hide().find("input").attr("checked",!1),this.$form.show().find(":input:visible:first").focus()},h.prototype.resetMessageForm=function(){return this.$selectedConversation!=null&&this.buildFormAudience(),this.$form.find("input[name!=authenticity_token], textarea").not(":checkbox").val("").change(),this.$form.find(".attachment:visible").remove(),this.$form.find(".media_comment").hide(),this.$form.find("#action_media_comment").show(),this.resize()},h.prototype.buildFormAudience=function(){var a,b,c,e,g,h,i;c=this.$form.find(".audience"),c.html(this.$selectedConversation.find(".audience").html()),c.find("em").attr("id","form_contexts"),a=c.find(".context"),i=[];for(g=0,h=a.length;g<h;g++)e=a[g],b=d(e),i.push(b.replaceWith("<a href='"+f(b.data("url"))+"'>"+f(b.html())+"</a>"));return i},h.prototype.parseQueryString=function(a){var b,c,d,e,f,g,h,i;a==null&&(a=window.location.search.substr(1)),b={},h=a.split(/\&/);for(f=0,g=h.length;f<g;f++)d=h[f],i=d.split(/\=/,2),c=i[0],e=i[1],b[decodeURIComponent(c)]=decodeURIComponent(e);return b},h.prototype.isSelected=function(a){return this.$selectedConversation&&this.$selectedConversation.attr("id")===(a!=null?a.attr("id"):void 0)},h.prototype.selectUnloadedConversation=function(b,c){return d.ajaxJSON("/conversations/"+b,"GET",{},a(function(a){return this.addConversation(a,!0),d("#conversation_"+b).hide(),this.selectConversation(d("#conversation_"+b),d.extend(c,{data:a}))},this))},h.prototype.noMessagesCheck=function(){return d("#no_messages").showIf(!this.$conversationList.find("li:not([id=conversations_loader])").length)},h.prototype.selectConversation=function(b,c){var e,f,g;c==null&&(c={}),this.toggleMessageActions(!1);if(this.isSelected(b)){this.$selectedConversation.removeClass("inactive"),this.$messageList.find("li.selected").removeClass("selected");return}this.$messageList.removeClass("private").hide().html(""),(b!=null?b.hasClass("private"):void 0)&&this.$messageList.addClass("private"),this.$selectedConversation&&(this.$selectedConversation.removeClass("selected inactive"),this.scope==="unread"&&this.$selectedConversation.fadeOut("fast",a(function(a){return d(a.currentTarget).remove(),this.noMessagesCheck()},this)),this.$selectedConversation=null),b&&(this.$selectedConversation=b.addClass("selected")),this.$selectedConversation||d("#action_compose_message").length?(this.showMessageForm(),c.message&&this.$form.find("#body").val(c.message)):this.$form.parent().hide();if(this.$selectedConversation)this.$selectedConversation.scrollIntoView();else{c.user_id&&(d("#from_conversation_id").val(c.from_conversation_id),d("#recipients").data("token_input").selector.addByUserId(c.user_id,c.from_conversation_id));return}return e=this.$selectedConversation,f=a(function(a){var b,c,d,f,g,h,i,j,k;if(!this.isSelected(e))return;i=a.participants;for(d=0,g=i.length;d<g;d++){c=i[d];if((j=this.userCache[c.id])!=null?!j.avatar_url:!void 0)this.userCache[c.id]=c,c.htmlName=this.htmlNameForUser(c)}a["private"]&&(c=function(){var b,d,e,f;e=a.participants,f=[];for(b=0,d=e.length;b<d;b++)c=e[b],c.id!==this.currentUser.id&&f.push(c);return f}.call(this)[0]&&this.canAddNotesFor(c))&&this.$form.find("#user_note_info").show(),this.resize(),this.$messages.show(),k=a.messages;for(f=0,h=k.length;f<h;f++)b=k[f],this.$messageList.append(this.buildMessage(b));this.$messageList.show();if(this.$selectedConversation.hasClass("unread"))return this.setConversationState(this.$selectedConversation,"read")},this),c.data?f(c.data):(g=this.$selectedConversation.find("a.details_link").attr("href"),this.$messageList.show().disableWhileLoading(d.ajaxJSON(g,"GET",{},f)))},h.prototype.contextList=function(a,b,c){var e,g,h,i,j,k,l,m;return b==null&&(b=!1),c==null&&(c=2),e=function(a,b){var c,d;return c=a.name.toLowerCase(),d=b.name.toLowerCase(),c<d?-1:c>d?1:0},i=function(a){return b&&a.type==="course"?"<span class='context' data-url='"+f(a.url)+"'>"+f(a.name)+"</span>":f(a.name)},m=function(){var b,c;b=a.courses,c=[];for(k in b)l=b[k],(h=this.contexts.courses[k])&&c.push(h);return c}.call(this).concat(function(){var b,c;b=a.groups,c=[];for(k in b)l=b[k],(j=this.contexts.groups[k])&&c.push(j);return c}.call(this)).sort(e).slice(0,c),d.toSentence(function(){var a,b,c;c=[];for(a=0,b=m.length;a<b;a++)g=m[a],c.push(i(g));return c}())},h.prototype.htmlNameForUser=function(a,b){var c,d;return b==null&&(b={courses:a.common_courses,groups:a.common_groups}),f(a.name)+(((c=b.courses)!=null?c.length:void 0)||((d=b.groups)!=null?d.length:void 0)?" <em>"+f(this.contextList(b))+"</em>":"")},h.prototype.canAddNotesFor=function(a){var c,d,e,f;if(!this.options.NOTES_ENABLED)return!1;if(a.can_add_notes)return!0;e=a.common_courses;for(c in e){d=e[c];if(b.call(d,"StudentEnrollment")>=0&&(this.options.CAN_ADD_NOTES_FOR_ACCOUNT||((f=this.contexts.courses[c])!=null?f.can_add_notes:void 0)))return!0}return!1},h.prototype.buildMessage=function(b){var e,g,h,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;if(b.submission)return this.buildSubmission(b);h=d("#message_blank").clone(!0).attr("id","message_"+b.id),h.data("id",b.id),h.addClass(b.generated?"generated":b.author_id===this.currentUser.id?"self":"other"),h.addClass("forwardable"),p=this.userCache[b.author_id],(m=p!=null?p.avatar_url:void 0)&&h.prepend(d("<img />").attr("src",m).addClass("avatar")),p&&(v=p.htmlName)==null&&(p.htmlName=this.htmlNameForUser(p)),q=(w=p!=null?p.name:void 0)!=null?w:c.t("unknown_user","Unknown user"),h.find(".audience").html((p!=null?p.htmlName:void 0)||f(q)),h.find("span.date").text(d.parseFromISO(b.created_at).datetime_formatted),h.find("p").html(i.formatMessage(b.body)),h.find("a.show_quoted_text_link").click(a(function(a){var b,c;b=d(a.currentTarget),c=b.parents(".quoted_text_holder").children(".quoted_text");if(c.length)return event.stopPropagation(),event.preventDefault(),c.show(),b.hide()},this)),j=h.find("a.send_private_message"),n=d.replaceTags(j.attr("href"),{user_id:b.author_id,user_name:encodeURIComponent(q),from_conversation_id:this.$selectedConversation.data("id")}),j.attr("href",n).click(a(function(a){return a.stopPropagation()},this));if((x=b.forwarded_messages)!=null?x.length:void 0){k=d('<ul class="messages"></ul>'),y=b.forwarded_messages;for(r=0,t=y.length;r<t;r++)o=y[r],k.append(this.buildMessage(o));h.append(k)}k=h.find("ul.message_attachments").detach(),g=k.find(".media_object_blank").detach(),e=k.find(".attachment_blank").detach();if(b.media_comment!=null||((z=b.attachments)!=null?z.length:void 0)){h.append(k),b.media_comment!=null&&k.append(this.buildMediaObject(g,b.media_comment));if(b.attachments!=null){A=b.attachments;for(s=0,u=A.length;s<u;s++)l=A[s],k.append(this.buildAttachment(e,l))}}return h},h.prototype.buildMediaObject=function(a,b){var c;return c=a.clone(!0).attr("id","media_comment_"+b.media_id),c.find("span.title").html(f(b.display_name)),c.find("span.media_comment_id").html(f(b.media_id)),c.find(".instructure_inline_media_comment").data("media_comment_type",b.media_type),c},h.prototype.buildAttachment=function(b,c){var d,e;return d=b.clone(!0).attr("id","attachment_"+c.id),d.data("id",c.id),d.find("span.title").html(f(c.display_name)),e=d.find("a"),e.attr("href",c.url),e.click(a(function(a){return a.stopPropagation()},this)),d},h.prototype.buildSubmission=function(b){var e,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;k=d("#submission_blank").clone(!0).attr("id",b.id),k.data("id",b.id),b=b.submission,l=k.find("ul"),h=l.find("li.header"),n=d.replaceTags(h.find("a").attr("href"),{course_id:b.assignment.course_id,assignment_id:b.assignment_id,id:b.user_id}),h.find("a").attr("href",n),s=this.userCache[b.user_id],s&&(u=s.htmlName)==null&&(s.htmlName=this.htmlNameForUser(s)),t=(v=s!=null?s.name:void 0)!=null?v:c.t("unknown_user","Unknown user"),h.find(".title").html(f(b.assignment.name)),h.find("span.date").text(b.submitted_at?d.parseFromISO(b.submitted_at).datetime_formatted:c.t("not_applicable","N/A")),h.find(".audience").html((s!=null?s.htmlName:void 0)||f(t)),b.score&&b.assignment.points_possible?r=""+b.score+" / "+b.assignment.points_possible:r=(w=b.score)!=null?w:c.t("not_scored","no score"),h.find(".score").html(r),g=l.find(".comment").detach(),p=0,q=4;for(o=x=b.submission_comments.length-1;o>=0;o+=-1){m=b.submission_comments[o];if(p<10)p++,e=this.buildSubmissionComment(g,m),p>q&&e.hide(),l.append(e);else break}return j=l.find(".more").detach(),p>q&&(i=j.clone(!0),i.find(".hidden").text(p-q),i.attr("title",f(c.t("titles.expand_inline","Show more comments"))),i.click(a(function(a){var b;return b=d(a.currentTarget),k=b.closest(".submission"),k.find(".more:hidden").show(),b.hide(),k.find(".comment:hidden").slideDown("fast"),this.resize(),!1},this)),l.append(i)),b.submission_comments.length>p&&(j.find("a").attr("href",n).attr("target","_blank"),j.find(".hidden").text(b.submission_comments.length-p),j.attr("title",f(c.t("titles.view_submission","Open submission in new window."))),b.submission_comments.length>q&&j.hide(),l.append(j)),k},h.prototype.buildSubmissionComment=function(a,b){var e,g,h,i,j,k;return e=a.clone(!0),h=this.userCache[b.author_id],(g=h!=null?h.avatar_url:void 0)&&e.prepend(d("<img />").attr("src",g).addClass("avatar")),h&&(j=h.htmlName)==null&&(h.htmlName=this.htmlNameForUser(h)),i=(k=h!=null?h.name:void 0)!=null?k:c.t("unknown_user","Unknown user"),e.find(".audience").html((h!=null?h.htmlName:void 0)||f(i)),e.find("span.date").text(d.parseFromISO(b.created_at).datetime_formatted),e.find("p").html(f(b.comment).replace(/\n/g,"<br />")),e},h.prototype.inboxActionUrlFor=function(a,b){return d.replaceTags(a.attr("href"),"id",b.data("id"))},h.prototype.inboxAction=function(b,c){var e,f,g,h,i,j;e=(h=c.loadingNode)!=null?h:b.closest("ul.conversations li"),e.length||(e=d("#conversation_actions").data("selectedConversation")),g={loadingNode:e,url:this.inboxActionUrlFor(b,e),method:"POST",data:{}},c=d.extend(g,c);if((i=typeof c.before==="function"?c.before(c.loadingNode,c):void 0)!=null?!i:!1)return;return f=d.ajaxJSON(c.url,c.method,c.data,a(function(a){return typeof c.success=="function"?c.success(c.loadingNode,a):void 0},this),a(function(a){return typeof c.error=="function"?c.error(c.loadingNode,a):void 0},this)),(j=c.loadingNode)!=null?j.disableWhileLoading(f):void 0},h.prototype.addConversation=function(b,c){var e;return d("#no_messages").hide(),e=d("#conversation_"+b.id),e.length?e.show():e=d("#conversation_blank").clone(!0).attr("id","conversation_"+b.id),e.data("id",b.id),b.avatar_url&&e.prepend(d("<img />").attr("src",b.avatar_url).addClass("avatar")),e[c?"appendTo":"prependTo"](this.$conversationList).click(a(function(a){return a.preventDefault(),this.setHash("#/conversations/"+d(a.currentTarget).data("id"))},this)),this.updateConversation(e,b,null),c||e.hide().slideDown("fast"),this.$conversationList.append(d("#conversations_loader")),e},h.prototype.htmlAudienceForConversation=function(a,b){var e,g,h,i;return b==null&&(b=2),e=a.audience,e.length===0?"<span>"+f(c.t("notes_to_self","Monologue"))+"</span>":(g="<em>"+this.contextList(a.audience_contexts,!0)+"</em>",e.length===1?"<span>"+f(this.userCache[e[0]].name)+"</span> "+g:(e.length>b&&(e=e.slice(0,b).concat([e.slice(b,e.length)])),d.toSentence(function(){var a,b,d;d=[];for(a=0,b=e.length;a<b;a++)i=e[a],d.push(typeof i=="number"?"<span>"+f(this.userCache[i].name)+"</span>":"<span class='others'>\n  "+f(c.t("other","other",{count:i.length}))+"\n  <span>\n    <ul>\n      "+function(){var a,b,c;c=[];for(a=0,b=i.length;a<b;a++)h=i[a],c.push("<li>"+f(this.userCache[h].name)+"</li>");return c}.call(this).join("")+"\n    </ul>\n  </span>\n</span>");return d}.call(this))+" "+g))},h.prototype.lastMessageKey=function(){return this.scope==="sent"?"last_authored_message":"last_message"},h.prototype.lastMessageAtKey=function(){return""+this.lastMessageKey()+"_at"},h.prototype.updateConversation=function(b,c,f){var g,h,i,j,k,l,m,n,o,p,q,r;f==null&&(f="slide"),k=this.lastMessageAtKey();if(!c[k])return this.removeConversation(b);this.toggleMessageActions(!1),g=b.find("a.details_link"),g.attr("href",d.replaceTags(g.attr("href"),"id",c.id)),g.attr("add_url",d.replaceTags(g.attr("add_url"),"id",c.id));if(c.participants){q=c.participants;for(m=0,o=q.length;m<o;m++)l=q[m],this.userCache[l.id]||(this.userCache[l.id]=l)}c.audience&&(b.data("audience",c.audience.concat([this.currentUser.id])),b.find(".audience").html(this.htmlAudienceForConversation(c)),this.isSelected(b)&&this.buildFormAudience()),b.find(".actions a").click(a(function(a){return a.preventDefault(),a.stopImmediatePropagation(),this.closeMenus(),this.openConversationMenu(d(a.currentTarget))},this)).focus(a(function(){return this.closeMenus(),this.openConversationMenu(d(e.currentTarget))},this)),c.message_count!=null&&(b.find(".count").text(c.message_count),b.find(".count").showIf(c.message_count>1)),b.find("span.date").text(d.friendlyDatetime(d.parseFromISO(c[k]).datetime)),i=b.data(k)>c[k]?"down":"up",b.data(k,c[k]),b.data("starred",c.starred),h=b.find("p"),h.text(c[this.lastMessageKey()]);if(c.properties.length){r=c.properties;for(n=0,p=r.length;n<p;n++)j=r[n],b.addClass(j)}c["private"]&&b.addClass("private"),c.starred&&b.addClass("starred"),c.subscribed||b.addClass("unsubscribed"),this.setConversationState(b,c.workflow_state);if(f)return this.repositionConversation(b,i,f)},h.prototype.repositionConversation=function(b,c,d){var e,f,g,h;b.show(),h=this.lastMessageAtKey(),g=b.data(h),f=b;if(c==="up")while(f.prev()&&f.prev().data(h)<g)f=f.prev();else while(f.next()&&f.next().data(h)>g)f=f.next();if(f===b)return;return d==="immediate"?b.detach()[c==="up"?"insertBefore":"insertAfter"](f):(e=b.clone().insertAfter(b),b.detach()[c==="up"?"insertBefore":"insertAfter"](f).animate({opacity:"toggle",height:"toggle"},0),e.animate({opacity:"toggle",height:"toggle"},200,a(function(){return e.remove()},this)),b.animate({opacity:"toggle",height:"toggle"},200,a(function(){return b.scrollIntoView()},this)))},h.prototype.removeConversation=function(b){var c;return c=this.isSelected(b),b.fadeOut("fast",a(function(){b.remove(),this.noMessagesCheck();if(c)return this.setHash("")},this))},h.prototype.setConversationState=function(a,b){return a.removeClass("read unread archived").addClass(b)},h.prototype.openConversationMenu=function(b){var c,e,f,g;return f={node:b,container:d("#conversation_actions"),conversation:b.closest("li"),parent:b.parent(),lists:d("#conversation_actions ul"),listElements:d("#conversation_actions li"),focusable:d("a, input, select, textarea"),actions:{markAsRead:d("#action_mark_as_read").parent(),markAsUnread:d("#action_mark_as_unread").parent(),unstar:d("#action_unstar").parent(),star:d("#action_star").parent(),unsubscribe:d("#action_unsubscribe").parent(),subscribe:d("#action_subscribe").parent(),forward:d("#action_forward").parent(),archive:d("#action_archive").parent(),unarchive:d("#action_unarchive").parent(),"delete":d("#action_delete").parent(),deleteAll:d("#action_delete_all").parent()}},this.activeActionMenu=f.node,f.parent.addClass("selected"),f.container.addClass("selected"),f.conversation.addClass("menu_active"),c=f.container,e=f.conversation,f.container.data("selectedConversation",f.conversation),f.lists.removeClass("first last").hide(),f.listElements.hide(),f.conversation.hasClass("unread")&&f.actions.markAsRead.show(),f.conversation.hasClass("read")&&f.actions.markAsUnread.show(),f.conversation.hasClass("starred")?f.actions.unstar.show():f.actions.star.show(),f.conversation.hasClass("private")?(f.actions.subscribe.hide(),f.actions.unsubscribe.hide()):(f.conversation.hasClass("unsubscribed")||f.actions.unsubscribe.show(),f.conversation.hasClass("unsubscribed")&&f.actions.subscribe.show()),f.actions.forward.show(),f.actions["delete"].show(),f.actions.deleteAll.show(),this.scope==="archived"?f.actions.unarchive.show():f.actions.archive.show(),d(window).one("keydown",a(function(b){if(b.keyCode!==9||b.shiftKey)return;return f.focusable.one("focus.actions_menu",a(function(b){return this.nextElement=d(b.target),f.focusable.unbind(".actions_menu"),f.container.find("a:visible:first").focus(),f.container.find("a:visible:first").bind("blur.actions_menu",b,a(function(){return d(window).one("keyup",a(function(a){var b;b=f.container.find("a:focus").length;if(!b)return f.container.find("a.visible").unbind(".actions_menu"),this.activeActionMenu.focus()},this))},this)),f.container.find("a:visible:last").bind("blur.actions_menu",b,a(function(){return d(window).one("keyup",a(function(a){var b;b=f.container.find("a:focus").length;if(!b)return f.container.find("a.visible").unbind(".actions_menu"),this.nextElement.focus(),this.closeMenus()},this))},this))},this))},this)),f.container.find('li[style*="list-item"]').parent().show(),f.groups=f.container.find('ul[style*="block"]'),f.groups.length&&(f.groups.first().addClass("first"),f.groups.last().addClass("last")),g=f.node.offset(),f.container.css({left:g.left+f.node.width()/2-f.container.offsetParent().offset().left-f.container.width()/2,top:g.top+f.node.height()*.9-f.container.offsetParent().offset().top})},h.prototype.closeMenus=function(){return d("#actions .menus > li, #conversation_actions, #conversations .actions").removeClass("selected"),d("#conversations li.menu_active").removeClass("menu_active")},h.prototype.openMenu=function(a){var b,c;this.closeMenus();if(!a.hasClass("disabled"))return b=a.parent("li, span").addClass("selected").find("div"),c=-(b.parent().position().left+b.parent().outerWidth()/2)+6,c<-(b.outerWidth()/2)&&(c=-(b.outerWidth()/2)),b.css("margin-left",c+"px")},h.prototype.resize=function(){var a;return a=d(window).height()-d("#header").outerHeight(!0)-(d("#wrapper-container").outerHeight(!0)-d("#wrapper-container").height())-(d("#main").outerHeight(!0)-d("#main").height())-d("#breadcrumbs").outerHeight(!0)-d("#footer").outerHeight(!0),a<this.minHeight&&(a=this.minHeight),d(document.body).toggleClass("too_small",a<=this.minHeight),this.$inbox.height(a),this.$messageList.height(a-this.$form.outerHeight(!0)),this.$conversationList.height(a-d("#actions").outerHeight(!0))},h.prototype.toggleMessageActions=function(a){return a!=null?(this.$messageList.find("> li").removeClass("selected"),this.$messageList.find("> li :checkbox").attr("checked",!1)):a=!!this.$messageList.find("li.selected").length,d("#action_forward").parent().showIf(a&&this.$messageList.find("li.selected.forwardable").length),a?d("#message_actions").slideDown(100):d("#message_actions").slideUp(100),this.$form[a?"addClass":"removeClass"]("disabled")},h.prototype.setHash=function(a){if(a!==location.hash)return location.hash=a,d(document).triggerHandler("document_fragment_change",a)},h.prototype.initializeHelp=function(){return d("#help_crumb").click(a(function(a){return a.preventDefault(),g()},this))},h.prototype.initializeForms=function(){return d("#create_message_form, #forward_message_form").find("textarea").elastic().keypress(a(function(a){if(a.which===13&&a.shiftKey)return a.preventDefault(),d(a.target).closest("form").submit(),!1},this)),this.$form=d("#create_message_form"),this.$addForm=d("#add_recipients_form"),this.$forwardForm=d("#forward_message_form"),this.$form.submit(a(function(a){var b;return b=!!this.$form.find("#body").val()&&(this.$form.find("#recipient_info").filter(":visible").length===0||this.$form.find(".token_input li").length>0),b||a.stopImmediatePropagation(),b},this)),this.$form.formSubmit({fileUpload:a(function(){return this.$form.find(".file_input:visible").length>0},this),preparedFileUpload:!0,context_code:"user_"+d("#identity .user_id").text(),folder_id:this.options.FOLDER_ID,intent:"message",formDataTarget:"url",handle_files:function(a,b){var c;return b.attachment_ids=function(){var b,d,e;e=[];for(b=0,d=a.length;b<d;b++)c=a[b],e.push(c.attachment.id);return e}(),b},disableWhileLoading:!0,success:a(function(a){var b,e,f,g;a.length==null&&(a=[a]);for(f=0,g=a.length;f<g;f++)e=a[f],b=d("#conversation_"+e.id),b.length?(this.isSelected(b)&&this.buildMessage(e.messages[0]).prependTo(this.$messageList).slideDown("fast"),this.updateConversation(b,e,a.length===1?"slide":"immediate")):e[this.lastMessageAtKey()]&&this.addConversation(e),a.length===1&&this.setHash("#/conversations/"+e.id);return d.flashMessage(a.length>1?c.t("messages_sent","Messages Sent"):c.t("message_sent","Message Sent")),this.resetMessageForm()},this),error:a(function(a){var b,e;if(typeof a.isRejected=="function"?a.isRejected():void 0)return;return b=a[0],(b!=null?b.attribute:void 0)==="body"?this.$form.find("#body").errorBox(c.t("message_blank_error","No message was specified")):(e=(b!=null?b.attribute:void 0)==="recipients"?b.message==="blank"?c.t("recipient_blank_error","No recipients were specified"):c.t("recipient_error","The course or group you have selected has no valid recipients"):c.t("unspecified_error","An unexpected error occurred, please try again"),this.$form.find(".token_input").errorBox(e)),d(".error_box").filter(":visible").css("z-index",10)},this)}),this.$form.click(a(function(){return this.toggleMessageActions(!1)},this)),this.$addForm.submit(a(function(a){var b;return b=!!this.$addForm.find(".token_input li").length,b||a.stopImmediatePropagation(),b},this)),this.$addForm.formSubmit({disableWhileLoading:!0,success:a(function(a){return this.buildMessage(a.messages[0]).prependTo(this.$messageList).slideDown("fast"),this.updateConversation(this.$selectedConversation,a),this.resetMessageForm(),this.$addForm.dialog("close")},this),error:a(function(a){return this.$addForm.dialog("close")},this)}),this.$forwardForm.submit(a(function(a){var b;return b=!!this.$forwardForm.find("#forward_body").val()&&!!this.$forwardForm.find(".token_input li").length,b||a.stopImmediatePropagation(),b},this)),this.$forwardForm.formSubmit({disableWhileLoading:!0,success:a(function(a){var b,c;return c=a[0],b=d("#conversation_"+c.id),b.length?(this.isSelected(b)&&this.buildMessage(c.messages[0]).prependTo(this.$messageList).slideDown("fast"),this.updateConversation(b,c)):this.addConversation(c),this.setHash("#/conversations/"+c.id),this.resetMessageForm(),this.$forwardForm.dialog("close")},this),error:a(function(a){return this.$forwardForm.dialog("close")},this)}),this.$messageList.click(a(function(a){var b,c;if(!d(a.target).closest("a.instructure_inline_media_comment").length)return b=d(a.target).closest("#messages > ul > li"),b.hasClass("generated")||((c=this.$selectedConversation)!=null&&c.addClass("inactive"),b.toggleClass("selected"),b.find("> :checkbox").attr("checked",b.hasClass("selected"))),this.toggleMessageActions()},this))},h.prototype.initializeMenus=function(){return d(".menus > li > a").click(a(function(a){return a.preventDefault(a),this.openMenu(d(a.currentTarget))},this)).focus(a(function(a){return this.openMenu(d(a.currentTarget))},this)),d(document).bind("mousedown",a(function(a){d(a.target).closest("span.others").find("> span").length||d("span.others > span").hide();if(!d(a.target).closest(".menus > li, #conversation_actions, #conversations .actions").length)return this.closeMenus()},this)),d("#menu_views").parent().find("li a").click(a(function(a){return this.closeMenus(),this.lockUntilUserInput(),d("#menu_views").text(d(a.currentTarget).text())},this)),this.$conversations.delegate(".actions a","blur",a(function(b){return d(window).one("keyup",a(function(a){if(a.shiftKey)return this.closeMenus()},this))},this))},h.prototype.initializeMessageActions=function(){return d("#message_actions").find("a").click(a(function(a){return a.preventDefault()},this)),d("#cancel_bulk_message_action").click(a(function(){return this.toggleMessageActions(!1)},this))},h.prototype.initializeConversationActions=function(){return d("#conversation_actions").find("li a").click(a(function(a){return a.preventDefault(),this.closeMenus()},this)),d(".action_mark_as_read").click(a(function(b){return b.preventDefault(),b.stopImmediatePropagation(),this.inboxAction(d(b.currentTarget),{method:"PUT",before:a(function(a){return this.scope!=="unread"&&this.setConversationState(a,"read"),!0},this),success:a(function(a){if(this.scope==="unread")return this.removeConversation(a)},this),error:a(function(a){if(this.scope!=="unread")return this.setConversationState(a("unread"))},this)})},this)),d(".action_mark_as_unread").click(a(function(b){return b.preventDefault(),b.stopImmediatePropagation(),this.inboxAction(d(b.currentTarget),{method:"PUT",before:a(function(a){return this.setConversationState(a,"unread")},this),error:a(function(a){return this.setConversationState(a,"read")},this)})},this)),d(".action_unstar").click(a(function(b){var c;return b.preventDefault(),b.stopImmediatePropagation(),c=null,this.inboxAction(d(b.currentTarget),{method:"PUT",before:a(function(a){return c=a.data("starred"),c&&a.removeClass("starred"),c},this),success:a(function(a,b){this.updateConversation(a,b);if(this.scope==="starred")return this.removeConversation(a)},this),error:a(function(a){return a.addClass("starred")},this)})},this)),d(".action_star").click(a(function(b){var c;return b.preventDefault(),b.stopImmediatePropagation(),c=null,this.inboxAction(d(b.currentTarget),{method:"PUT",before:a(function(a,b){return c=a.data("starred"),c||a.addClass("starred"),!c},this),success:a(function(a,b){return this.updateConversation(a,b)},this),error:a(function(a){return a.removeClass("starred")},this)})},this)),d("#action_add_recipients").click(a(function(b){return b.preventDefault(),this.$addForm.attr("action",this.inboxActionUrlFor(d(b.currentTarget),this.$selectedConversation)).dialog("close").dialog({width:420,title:c.t("title.add_recipients","Add Recipients"),buttons:[{text:c.t("buttons.add_people","Add People"),click:a(function(){return this.$addForm.submit()},this)},{text:c.t("#buttons.cancel","Cancel"),click:a(function(){return this.$addForm.dialog("close")},this)}],open:a(function(){var a;return a=d("#add_recipients").data("token_input"),a.baseExclude=this.$selectedConversation.data("audience"),this.$addForm.find("input[name!=authenticity_token]").val("").change()},this),close:a(function(){return d("#add_recipients").data("token_input").input.blur()},this)})},this)),d("#action_subscribe").click(a(function(b){return this.inboxAction(d(b.currentTarget),{method:"PUT",data:{subscribed:1},success:a(function(a){return a.removeClass("unsubscribed")},this)})},this)),d("#action_unsubscribe").click(a(function(b){return this.inboxAction(d(b.currentTarget),{method:"PUT",data:{subscribed:0},success:a(function(a){return a.addClass("unsubscribed")},this)})},this)),d("#action_archive, #action_unarchive").click(a(function(b){return this.inboxAction(d(b.currentTarget),{method:"PUT",success:a(function(a){return this.removeConversation(a)},this)})},this)),d("#action_delete_all").click(a(function(b){if(confirm(c.t("confirm.delete_conversation","Are you sure you want to delete your copy of this conversation? This action cannot be undone.")))return this.inboxAction(d(b.currentTarget),{method:"DELETE",success:a(function(a){return this.removeConversation(a)},this)})},this)),d("#action_delete").click(a(function(b){var e,f;e=this.$messageList.find(".selected"),f=e.length>1?c.t("confirm.delete_messages","Are you sure you want to delete your copy of these messages? This action cannot be undone."):c.t("confirm.delete_message","Are you sure you want to delete your copy of this message? This action cannot be undone.");if(confirm(f))return e.fadeOut("fast"),this.inboxAction(d(b.currentTarget),{loadingNode:this.$selectedConversation,data:{remove:function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)f=e[a],c.push(d(f).data("id"));return c}()},success:a(function(a,b){var c;return c=".selected, .generated",this.scope==="sent"&&(c+=", .other"),this.$messageList.find("> li").not(c).length?(e.remove(),this.updateConversation(a,b)):this.removeConversation(a)},this),error:a(function(){return e.show()},this)})},this)),d("#action_forward").click(a(function(b){var e;return this.$forwardForm.find("input[name!=authenticity_token], textarea").val("").change(),e=this.$forwardForm.find("ul.messages").first(),e.html(""),e.html(this.$messageList.find("> li.selected.forwardable").clone(!0).removeAttr("id").removeClass("self")),e.find("> li").removeClass("selected odd").find("> :checkbox").attr("checked",!0).attr("name","forwarded_message_ids[]").val(function(){return d(this).closest("li").data("id")}),e.find("> li").last().addClass("last"),this.$forwardForm.css("max-height",d(window).height()-300+"px").dialog("close").dialog({position:"center",height:"auto",width:510,title:c.t("title.forward_messages","Forward Messages"),buttons:[{text:c.t("buttons.send_message","Send"),click:function(){return d(this).submit()}},{text:c.t("#buttons.cancel","Cancel"),click:function(){return d(this).dialog("close")}}],close:a(function(){return d("#forward_recipients").data("token_input").input.blur()},this)})},this))},h.prototype.initializeTemplates=function(){var b;return d("#conversation_blank .audience, #create_message_form .audience").click(a(function(a){var b;if((b=d(a.target).closest("span.others").find("> span")).length)return d(a.target).closest("span.others > span").length||(d("span.others > span").not(b).hide(),b.toggle(),b.css("left",b.parent().position().left),b.css("top",b.parent().height()+b.parent().position().top)),a.preventDefault(),!1},this)),b=0,d("#action_add_attachment").click(a(function(c){var e;return c.preventDefault(),e=d("#attachment_blank").clone(!0),e.attr("id",null),e.find("input[type='file']").attr("name","attachments["+b++ +"]"),d("#attachment_list").append(e),e.slideDown("fast",a(function(){return this.resize()},this)),!1},this)),d("#attachment_blank a.remove_link").click(a(function(b){var c;return b.preventDefault(),c=d(b.currentTarget).closest(".attachment"),c.slideUp("fast",a(function(){return this.resize(),c.remove()},this)),!1},this)),d("#action_media_comment").click(a(function(b){return b.preventDefault(),d("#create_message_form .media_comment").mediaComment("create","any",a(function(a,b){return d("#media_comment_id").val(a),d("#media_comment_type").val(b),d("#create_message_form .media_comment").show(),d("#action_media_comment").hide()},this))},this)),d("#create_message_form .media_comment a.remove_link").click(a(function(a){return a.preventDefault(),d("#media_comment_id").val(""),d("#media_comment_type").val(""),d("#create_message_form .media_comment").hide(),d("#action_media_comment").show()},this))},h.prototype.buildContextInfo=function(a){var b,c,e;c=a.id.match(/^(course|section)_(\d+)$/),c&&(e=this.contexts[""+c[1]+"s"][c[2]]),b=a.context_name||"",b=b.length<40?b:b.substr(0,40)+"...";if(e!=null?e.term:void 0)b=b?""+b+" - "+e.term:e.term;return b?d("<span />",{"class":"context_info"}).text("("+b+")"):""},h.prototype.lockUntilUserInput=function(){return setTimeout(a(function(){return this.$inbox.disableWhileLoading(this.untilUserInput())},this))},h.prototype.untilUserInput=function(){var a;return a=d.Deferred(),d("body").one("keydown click",a.resolve),a.promise()},h.prototype.initializeTokenInputs=function(){var b,e,f,g,h,i,j,k;b=a(function(b){return b==null&&(b={}),a(function(a,e,f,g){var h,i,j,k,l,m;g==null&&(g={}),f.id=""+f.id,f.avatar_url&&(j=d('<img class="avatar" />'),j.attr("src",f.avatar_url),e.append(j)),h=d("<b />"),h.text(f.name),k=d("<span />",{"class":"name"}),g.parent||(i=this.buildContextInfo(f)),k.append(h,i),l=d("<span />",{"class":"details"}),f.common_courses!=null?l.text(this.contextList({courses:f.common_courses,groups:f.common_groups})):f.type&&f.user_count!=null?l.text(c.t("people_count","person",{count:f.user_count})):f.item_count!=null?f.id.match(/_groups$/)?l.text(c.t("groups_count","group",{count:f.item_count})):f.id.match(/_sections$/)&&l.text(c.t("sections_count","section",{count:f.item_count})):f.subText&&l.text(f.subText),e.append(k,l),e.attr("title",f.name),m=f.name,g.parent&&(f.selectAll&&f.noExpand?m=g.parent.data("text"):f.id.match(/_\d+_/)&&(m=c.beforeLabel(g.parent.data("text"))+" "+m)),e.data("text",m),e.data("id",f.type==="context"||!b.prefixUserIds?f.id:"user_"+f.id),f.rootId=g.ancestors[0],e.data("user_data",f),e.addClass(f.type?f.type:"user"),g.level>0&&a.options.showToggles&&(e.prepend('<a class="toggle"><i></i></a>'),f.item_count||e.addClass("toggleable"));if(f.type==="context"&&!f.noExpand)return e.prepend('<a class="expand"><i></i></a>'),e.addClass("expandable")},this)},this),i=c.t("recipient_field_placeholder","Enter a name, course, or group"),h=c.t("no_results","No results found"),e=c.t("enrollments_everyone","Everyone"),j=c.t("select_all","Select All"),d(".recipients").tokenInput({placeholder:i,added:a(function(a,b,e){var f,g,h;a.id=""+a.id,e&&a.rootId&&b.append("<input type='hidden' name='tags[]' value='"+a.rootId+"'>"),e&&a.type&&(b.addClass(a.type),a.user_count!=null&&(b.addClass("details"),f=d("<span />"),f.text(c.t("people_count","person",{count:a.user_count})),b.append(f)));if(!a.id.match(/^(course|group)_/))return a=d.extend({},a),delete a.avatar_url,g=(h=this.userCache[a.id])!=null?h:{},this.userCache[a.id]=d.extend(g,a)},this),selector:{messages:{noResults:h},populator:b(),limiter:a(function(a){return a.level>0?-1:5},this),showToggles:!0,preparer:a(function(a,b,c){var d;d=a.context;if(!a.search&&d&&b.length>1){if(d.match(/^(course|section)_\d+$/))return b.unshift({id:""+d+"_all",name:e,user_count:c.data("user_data").user_count,type:"context",avatar_url:c.data("user_data").avatar_url,selectAll:!0});if(d.match(/^((course|section)_\d+_.*|group_\d+)$/)&&!d.match(/^course_\d+_(groups|sections)$/))return b.unshift({id:d,name:j,user_count:c.data("user_data").user_count,type:"context",avatar_url:c.data("user_data").avatar_url,selectAll:!0,noExpand:!0})}},this),baseData:{synthetic_contexts:1},browser:{data:{per_page:-1,type:"context"}}}}),k=d("#recipients").data("token_input"),k.$fakeInput.css("width","100%"),k.change=a(function(a){var b,c;return a.length>1||((c=a[0])!=null?c.match(/^(course|group)_/):void 0)?(this.$form.find("#group_conversation_info").is(":visible")||this.$form.find("#group_conversation").attr("checked",!1),this.$form.find("#group_conversation_info").show(),this.$form.find("#user_note_info").hide()):(this.$form.find("#group_conversation").attr("checked",!1),this.$form.find("#group_conversation_info").hide(),this.$form.find("#user_note_info").showIf((b=this.userCache[a[0]])&&this.canAddNotesFor(b))),this.resize()},this),d("#context_tags").tokenInput({placeholder:i,added:a(function(a,b,c){return b.prevAll().remove()},this),tokenWrapBuffer:80,selector:{messages:{noResults:h},populator:b({prefixUserIds:!0}),limiter:a(function(a){return 5},this),preparer:a(function(a,b,d){var f,g;f=a.context;if(!a.search&&f&&b.length>0&&f.match(/^(course|group)_\d+$/))return b.length>1&&f.match(/^course_/)&&b.unshift({id:""+f+"_all",name:e,user_count:d.data("user_data").user_count,type:"context",avatar_url:d.data("user_data").avatar_url}),g=f.match(/^course/)?c.t("filter_by_course","Fiter by this course"):c.t("filter_by_group","Fiter by this group"),b.unshift({id:f,name:d.data("text"),type:"context",avatar_url:d.data("user_data").avatar_url,subText:g,noExpand:!0})},this),baseData:{synthetic_contexts:1,types:["course","user","group"],include_inactive:!0},browser:{data:{per_page:-1,types:["context"]}}}}),g=d("#context_tags").data("token_input"),g.change=a(function(a){var b;if(this.currentFilter!==a[0])return b=location.href.replace(/[\?#].*|/g,""),a[0]&&(b+="?filter="+a[0]),g.$input.blur(),this.lockUntilUserInput(),location.href=b},this);if(f=this.options.INITIAL_FILTER)return this.currentFilter=f.id,g.addToken({value:f.id,text:f.name,data:d.extend(!0,{},f)})},h.prototype.initializeConversationsPane=function(b){var c,e,f;for(e=0,f=b.length;e<f;e++)c=b[e],this.addConversation(c,!0);return this.noMessagesCheck(),setTimeout(a(function(){return this.$conversationList.pageless({totalPages:Math.ceil(this.options.CONVERSATIONS_COUNT/this.options.CONVERSATIONS_PER_PAGE),container:this.$conversationList,params:{format:"json",per_page:this.options.CONVERSATIONS_PER_PAGE},loader:d("#conversations_loader"),scrape:a(function(a){var b,c,e;if(typeof a=="string"){try{a=d.parseJSON(a)||[]}catch(f){a=[]}for(c=0,e=a.length;c<e;c++)b=a[c],this.addConversation(b,!0)}return this.$conversationList.append(d("#conversations_loader")),!1},this)},1)},this))},h.prototype.initializeAutoResize=function(){return d(window).resize(a(function(){return this.resize()},this)),setTimeout(a(function(){return this.resize()},this))},h.prototype.initializeHashChange=function(){return d(window).bind("hashchange",a(function(){var a,b,c,e;b=location.hash;if(c=b.match(/^#\/conversations\/(\d+)(\?(.*))?/))return e=c[3]?this.parseQueryString(c[3]):{},(a=d("#conversation_"+c[1]))&&a.length?this.selectConversation(a,e):this.selectUnloadedConversation(c[1],e);e={};if(c=b.match(/^#\/conversations\?(.*)$/))e=this.parseQueryString(c[1]);return this.selectConversation(null,e)},this)).triggerHandler("hashchange")},h}()})}).call(this)